<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Ruby on Rails 教程 - 第 12 章 重设密码</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="最好的 Ruby on Rails 入门教程"/>
  <meta name="keywords" content="ruby, rails, tutorial"/>
  <meta name="author" content="Michael Hartl"/>
  <meta name="translator" content="安道"/>
  <meta name="generator" content="persie 0.0.3.beta.4"/>
  <link rel="stylesheet" type="text/css" href="//railstutorial-china.org/assets/css/main.css"/>
  <link rel="stylesheet" type="text/css" href="book.css"/>
  <script type="text/javascript" src="//railstutorial-china.org/assets/js/global.js"></script>
</head>

<body class="book-page">

  <nav class="navbar">
    <div class="container">

      <div class="clearfix">
        <a class="navbar-brand hidden-sm-up" href="//railstutorial-china.org/" title="Ruby on Rails 教程">Ruby on Rails 教程</a>
        <button class="navbar-toggler hidden-sm-up pull-xs-right" type="button" data-toggle="collapse" data-target="#main-nav">&#9776;</button>
      </div>

      <a class="navbar-brand hidden-xs-down" href="//railstutorial-china.org/" title="Ruby on Rails 教程">Ruby on Rails 教程</a>

      <div class="collapse navbar-toggleable-xs pull-sm-right" id="main-nav">
        <ul class="nav navbar-nav">
          <li class="nav-item"><a class="nav-link" href="//railstutorial-china.org/" title="首页">首页</a></li>
          <li class="nav-item"><a class="nav-link" href="//railstutorial-china.org/blog/" title="博客">博客</a></li>
          <li class="nav-item active"><a class="nav-link" href="//railstutorial-china.org/book/" title="阅读">阅读</a></li>
          <li class="nav-item"><a class="nav-link" href="//railstutorial-china.org/#ebook" title="电子书">电子书</a></li>
        </ul>
      </div>

    </div>
  </nav>


  <div class="content">
    <div class="container">
      <div class="row">
        <div class="col-lg-offset-2 col-lg-8">
          <div class="book-versions">
            选择版本：
            <a class="btn btn-primary" href="//railstutorial-china.org/book/" title="Ruby on Rails 教程（原书第 4 版，针对 Rails 5）">Rails 5</a>
            <a class="btn btn-secondary" href="//railstutorial-china.org/rails42/" title="Ruby on Rails 教程（原书第 3 版，针对 Rails 4.2）">Rails 4.2</a>
            <a class="btn btn-secondary" href="//railstutorial-china.org/rails4/" title="Ruby on Rails 教程（原书第 3 版，针对 Rails 4.0）">Rails 4.0</a>
            <a class="btn btn-secondary" href="//railstutorial-china.org/rails3/" title="Ruby on Rails 教程（原书第 2 版，针对 Rails 3.2）">Rails 3.2</a>
          </div>

          <div class="alert alert-warning">
            <p>在线版的内容可能落后于电子书，如果想及时获得更新，请<a href="//railstutorial-china.org/#ebook" title="购买电子书">购买电子书</a>。</p>
          </div>

          <article class="article">
            <section data-type="chapter" id="password-reset">
<h1><span class="title-label">第 12 章</span> 重设密码</h1>
<p>完成账户激活功能后（从而确认了用户的电子邮件地址可用），我们可以实现密码重设功能了，以防用户忘记密码。我们将看到，密码重设的很多步骤和账户激活类似，所以这里会用到<a class="xref-link" href="chapter11.html#account-activation">第 11 章</a>学到的知识。不过，开头不一样，与账户激活功能不同的是，密码重设要修改一个视图，还要创建两个新表单（用于提交电子邮件地址和设定新密码）。</p>
<p>编写代码之前，我们先构思要实现的重设密码步骤。首先，我们要在演示应用的登录表单中添加“forgot password”（忘记密码）链接，如<a class="xref-link" href="#fig-login-forgot-password-mockup">图 12.1</a> 所示。</p>
<div id="fig-login-forgot-password-mockup" class="figure"><img src="images/chapter12/login_forgot_password_mockup.png" alt="login forgot password mockup" /><div class="figcaption"><span class="title-label">图 12.1</span>：“forgot password”链接的构思图</div></div>
<p>点击“forgot password”链接后打开一个页面，这个页面中有一个表单，要求输入电子邮件地址，用户提交之后，应用向这个地址发送一封包含密码重设链接的邮件，如<a class="xref-link" href="#fig-forgot-password-form-mockup">图 12.2</a> 所示。</p>
<div id="fig-forgot-password-form-mockup" class="figure"><img src="images/chapter12/forgot_password_form_mockup.png" alt="forgot password form mockup" /><div class="figcaption"><span class="title-label">图 12.2</span>：“Forgot password”表单的构思图</div></div>
<p>点击密码重设链接会打开一个表单，用户在这个表单中重设密码（还要填写密码确认），如<a class="xref-link" href="#fig-reset-password-form-mockup">图 12.3</a> 所示。</p>
<div id="fig-reset-password-form-mockup" class="figure"><img src="images/chapter12/reset_password_form_mockup.png" alt="reset password form mockup" /><div class="figcaption"><span class="title-label">图 12.3</span>：“Reset password”表单的构思图</div></div>
<p>如果你读完了<a class="xref-link" href="chapter11.html#account-activation">第 11 章</a>，已经有了密码重设邮件程序（<a class="xref-link" href="chapter11.html#listing-generate-user-mailer">代码清单 11.6</a>）。本节将完成剩下的工作，为密码重设功能添加资源和数据模型。重设密码功能在 <a class="xref-link" href="#resetting-the-password">12.3 节</a>实现。</p>
<p>与账户激活功能一样，我们要把“密码重设”看做一个资源，每个重设密码操作都有一个重设令牌和对应的摘要。主要的步骤如下：</p>
<ol class="arabic">
<li>
<p>用户请求重设密码时，使用提交的电子邮件地址查找用户；</p>
</li>
<li>
<p>如果数据库中有这个电子邮件地址，生成一个重设令牌和对应的摘要；</p>
</li>
<li>
<p>把重设摘要保存在数据库中，然后给用户发送一封邮件，其中有一个包含重设令牌和用户电子邮件地址的链接；</p>
</li>
<li>
<p>用户点击链接后，使用电子邮件地址查找用户，然后对比令牌和摘要；</p>
</li>
<li>
<p>如果通过身份验证，显示重设密码表单。</p>
</li>
</ol>
<section data-type="sect1" id="password-resets-resource">
<h1><span class="title-label">12.1</span> <code>PasswordResets</code> 资源</h1>
<p>与会话（<a class="xref-link" href="chapter8.html#sessions">8.1 节</a>）和账户激活（<a class="xref-link" href="chapter11.html#account-activation">第 11 章</a>）一样，我们要把“密码重设”看做一个资源（<code>PasswordResets</code>），不过这个资源不对应 Active Record 模型，相关的数据（包括重设令牌）存储在 <code>User</code> 模型中。</p>
<p>我们将把“密码重设”看做一个资源，因此要使用标准的 REST URL 与之交互。处理激活链接只需 <code>edit</code> 一个动作，而这里要渲染 <code>new</code> 和 <code>edit</code> 表单，处理密码重设请求，还要创建和更新密码，因此最终共计要使用四个 REST 式路由。</p>
<p>与之前一样，我们要在主题分支中实现这个新功能：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>git checkout -b password-reset
</code></pre></div>
</div>
<section data-type="sect2" id="password-resets-controller">
<h2><span class="title-label">12.1.1</span> <code>PasswordResets</code> 控制器</h2>
<p>首先，生成 <code>PasswordResets</code> 控制器，并且根据上述讨论，指定 <code>new</code> 和 <code>edit</code> 两个动作：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails generate controller PasswordResets new edit --no-test-framework
</code></pre></div>
</div>
<p>注意，我们指定了一个旗标，不让 Rails 生成测试。这是因为我们不需要控制器测试，而将继续使用 <a class="xref-link" href="chapter11.html#activation-test-and-refactoring">11.3.3 节</a>编写的集成测试。</p>
<p>我们需要两个表单，一个请求重设密码（<a class="xref-link" href="#fig-forgot-password-form-mockup">图 12.2</a>），一个修改 <code>User</code> 模型中的密码（<a class="xref-link" href="#fig-reset-password-form-mockup">图 12.3</a>），所以需要为 <code>new</code>、<code>create</code>、<code>edit</code> 和 <code>update</code> 四个动作定义路由——通过<a class="xref-link" href="#listing-password-resets-resource">代码清单 12.1</a> 中高亮显示的那条 <code>resources</code> 规则实现。</p>
<div id="listing-password-resets-resource" data-type="listing">
<h5><span class="title-label">代码清单 12.1</span>：添加 <code>PasswordResets</code> 资源的路由</h5>

<div class="source-file">config/routes.rb</div>

<div class="highlight language-ruby"><pre><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span>   <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to: </span><span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to: </span><span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to: </span><span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to: </span><span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to: </span><span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'/logout'</span><span class="p">,</span>  <span class="ss">to: </span><span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only: </span><span class="p">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span></span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>添加这个规则后，得到了<a class="xref-link" href="#table-restful-password-resets">表 12.1</a> 中的 REST 式路由。</p>
<table id="table-restful-password-resets" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 12.1</span>：在<a class="xref-link" href="#listing-password-resets-resource">代码清单 12.1</a> 中添加那条规则后得到的 REST 式路由</caption>
<colgroup>
<col style="width: 15%;" />
<col style="width: 35%;" />
<col style="width: 15%;" />
<col style="width: 35%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HTTP 请求</th>
<th class="tableblock halign-left valign-top">URL</th>
<th class="tableblock halign-left valign-top">动作</th>
<th class="tableblock halign-left valign-top">具名路由</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets/new</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new_password_reset_path</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password_resets_path</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets/&lt;token&gt;/edit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>edit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>edit_password_reset_url(token)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PATCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets/&lt;token&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password_reset_path(token)</code></p></td>
</tr>
</tbody>
</table>
<p>通过表中第一个路由可以得到指向“Forgot password”表单的链接：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">new_password_reset_path</span>
</code></pre></div>
</div>
<p>把这个链接添加到登录表单，如<a class="xref-link" href="#listing-log-in-password-reset">代码清单 12.2</a> 所示。添加后的效果如<a class="xref-link" href="#fig-forgot-password-link">图 12.4</a> 所示。</p>
<div id="listing-log-in-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.2</span>：添加打开忘记密码表单的链接</h5>

<div class="source-file">app/views/sessions/new.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url: </span><span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"(forgot password)"</span><span class="p">,</span> <span class="n">new_password_reset_path</span> <span class="cp">%&gt;</span></span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<div id="fig-forgot-password-link" class="figure"><img src="images/chapter12/forgot_password_link.png" alt="forgot password link" /><div class="figcaption"><span class="title-label">图 12.4</span>：添加“Forgot Password”链接后的登录页面</div></div>
<h5 id="exercises-password-resets-controller" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>确认测试组件仍能通过。</p>
</li>
<li>
<p><a class="xref-link" href="#table-restful-password-resets">表 12.1</a> 为什么列出具名路由的 <code>_url</code> 形式，而不是 <code>_path</code> 形式？提示：我们将在电子邮件中使用链接。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="new-password-resets">
<h2><span class="title-label">12.1.2</span> 请求重设密码</h2>
<p>请求重设密码之前，我们要定义数据模型。密码重设所需的数据模型与账户激活的类似（<a class="xref-link" href="chapter11.html#fig-user-model-account-activation">图 11.1</a>）。参照“记住我”功能（<a class="xref-link" href="chapter9.html#remember-me">9.1 节</a>）和账户激活功能（<a class="xref-link" href="chapter11.html#account-activation">第 11 章</a>），密码重设需要一个虚拟的重设令牌属性，在重设密码的邮件中使用，以及对应的重设摘要，用于检索用户。如果存储未哈希的令牌，能访问数据库的攻击者就能发送一封重设密码邮件给用户，然后使用令牌和邮件地址访问对应的密码重设链接，从而获得账户控制权。因此，必须存储令牌的摘要。为了进一步保障安全，我们还计划过几个小时后让重设链接失效，所以要记录重设邮件发送的时间。据此，我们要添加两个属性：<code>reset_digest</code> 和 <code>reset_sent_at</code>，如<a class="xref-link" href="#fig-user-model-password-reset">图 12.5</a> 所示。</p>
<div id="fig-user-model-password-reset" class="figure"><img src="images/chapter12/user_model_password_reset.png" alt="user model password reset" /><div class="figcaption"><span class="title-label">图 12.5</span>：添加密码重设相关属性后的 <code>User</code> 模型</div></div>
<p>执行下面的命令，创建添加这两个属性的迁移：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails generate migration add_reset_to_users reset_digest:string <span class="se">\</span>
<span class="gp">&gt; </span>reset_sent_at:datetime
</code></pre></div>
</div>
<p>（前面说过，第二行开头的 <code>&gt;</code> 是“行接续”符号，是 shell 自动插入的，无需输入。）</p>
<p>然后像之前一样执行迁移：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails db:migrate
</code></pre></div>
</div>
<p>我们要参照前面为没有模型的资源编写表单的方式，即创建新会话的登录表单（<a class="xref-link" href="chapter8.html#listing-login-form">代码清单 8.4</a>），编写请求重设密码的表单。为了便于参考，我们再把那个表单列出来，如<a class="xref-link" href="#listing-login-form-redux">代码清单 12.3</a> 所示。</p>
<div id="listing-login-form-redux" data-type="listing">
<h5><span class="title-label">代码清单 12.3</span>：登录表单的代码</h5>

<div class="source-file">app/views/sessions/new.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url: </span><span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<p>请求重设密码的表单和<a class="xref-link" href="#listing-login-form-redux">代码清单 12.3</a> 有很多共通之处，二者之间最大的区别是，<code>form_for</code> 中的资源和地址不一样，而且也没有密码字段。请求重设密码的表单如<a class="xref-link" href="#listing-new-password-reset">代码清单 12.4</a> 所示，渲染的结果如<a class="xref-link" href="#fig-forgot-password-form">图 12.6</a> 所示。</p>
<div id="listing-new-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.4</span>：请求重设密码页面的视图</h5>

<div class="source-file">app/views/password_resets/new.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Forgot password"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Forgot password<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:password_reset</span><span class="p">,</span> <span class="ss">url: </span><span class="n">password_resets_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<div id="fig-forgot-password-form" class="figure"><img src="images/chapter12/forgot_password_form.png" alt="forgot password form" /><div class="figcaption"><span class="title-label">图 12.6</span>：“Forgot Password”表单</div></div>
<h5 id="exercises-new-password-resets" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在<a class="xref-link" href="#listing-new-password-reset">代码清单 12.4</a> 中，传给 <code>form_for</code> 的为什么是 <code>:password_reset</code>，而不是 <code>@password_reset</code>？</p>
</li>
</ol>
</section>
<section data-type="sect2" id="password-reset-create-action">
<h2><span class="title-label">12.1.3</span> <code>PasswordResets</code> 控制器的 <code>create</code> 动作</h2>
<p>提交<a class="xref-link" href="#fig-forgot-password-form">图 12.6</a> 中的表单后，我们要通过电子邮件地址查找用户，更新这个用户的 <code>reset_token</code>、<code>reset_digest</code> 和 <code>reset_sent_at</code> 属性，然后重定向到根地址，并显示一个闪现消息。与登录一样（<a class="xref-link" href="chapter8.html#listing-correct-login-failure">代码清单 8.11</a>），如果提交的数据无效，我们要重新渲染页面，并且使用 <code>flash.now</code> 显示一个闪现消息。<sup>[<a id="fn-ref-1" href="#fn-1">1</a>]</sup>据此写出的 <code>create</code> 动作如<a class="xref-link" href="#listing-create-password-reset">代码清单 12.5</a> 所示。</p>
<div id="listing-create-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.5</span>：<code>PasswordResets</code> 控制器的 <code>create</code> 动作</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:password_reset</span><span class="p">][</span><span class="ss">:email</span><span class="p">].</span><span class="nf">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">create_reset_digest</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">send_password_reset_email</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:info</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Email sent with password reset instructions"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">.</span><span class="nf">now</span><span class="p">[</span><span class="ss">:danger</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Email address not found"</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><code>User</code> 模型中的代码与 <code>before_create</code> 回调中使用的 <code>create_activation_digest</code> 方法（<a class="xref-link" href="chapter11.html#listing-user-model-activation-code">代码清单 11.3</a>）类似，如<a class="xref-link" href="#listing-user-model-password-reset">代码清单 12.6</a> 所示。</p>
<div id="listing-user-model-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.6</span>：在 <code>User</code> 模型中添加重设密码所需的方法</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span><span class="p">,</span> <span class="ss">:reset_token</span></span>
  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
  <span class="c1"># 激活账户</span>
  <span class="k">def</span> <span class="nf">activate</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 发送激活邮件</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_now</span>
  <span class="k">end</span>

  <span class="c1"># 设置密码重设相关的属性</span>
  <span class="k">def</span> <span class="nf">create_reset_digest</span>
<span class="hll">    <span class="nb">self</span><span class="p">.</span><span class="nf">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_token</span></span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_digest</span><span class="p">,</span>  <span class="no">User</span><span class="p">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">reset_token</span><span class="p">))</span></span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_sent_at</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span></span>
  <span class="k">end</span>

  <span class="c1"># 发送密码重设邮件</span>
  <span class="k">def</span> <span class="nf">send_password_reset_email</span>
<span class="hll">    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_now</span></span>
  <span class="k">end</span>

  <span class="kp">private</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>如<a class="xref-link" href="#fig-invalid-email-password-reset">图 12.7</a> 所示，提交无效的电子邮件地址时，应用的表现正常。为了让提交有效地址时应用也能正常运行，我们要定义发送密码重设邮件的方法。</p>
<div id="fig-invalid-email-password-reset" class="figure"><img src="images/chapter12/invalid_email_password_reset.png" alt="invalid email password reset" /><div class="figcaption"><span class="title-label">图 12.7</span>：提交无效电子邮件地址后显示的“Forgot Password”表单</div></div>
<h5 id="exercises-password-reset-create-action" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在<a class="xref-link" href="#fig-forgot-password-form">图 12.6</a> 所示的表单中提交有效的电子邮件地址，会看到什么错误消息？</p>
</li>
<li>
<p>在 Rails 控制台中确认，虽然前一题有错误，但是 <code>reset_digest</code> 和 <code>reset_sent_at</code> 属性有值了。这两个属性的值是什么？</p>
</li>
</ol>
</section>
</section>
<section data-type="sect1" id="password-reset-emails">
<h1><span class="title-label">12.2</span> 密码重设邮件</h1>
<p>前一节在 <code>PasswordResets</code> 控制器中定义的 <code>create</code> 动作基本可用，但是发送密码重设邮件的方法还没有。</p>
<p>如果你跟着 <a class="xref-link" href="chapter11.html#account-activations-resource">11.1 节</a>做了，<code>app/mailers/user_mailer.rb</code> 文件中应该有一个默认生成的 <code>password_reset</code> 方法，这是<a class="xref-link" href="chapter11.html#listing-generate-user-mailer">代码清单 11.6</a> 生成 <code>User</code> 邮件程序时生成的。如果你跳过了<a class="xref-link" href="chapter11.html#account-activation">第 11 章</a>，可以直接复制下面的代码（不含 <code>account_activation</code> 及相关的方法），并且创建缺少的文件。</p>
<section data-type="sect2" id="password-reset-mailer">
<h2><span class="title-label">12.2.1</span> 密码重设邮件程序和模板</h2>
<p>在<a class="xref-link" href="#listing-user-model-password-reset">代码清单 12.6</a> 中我们用到了 <a class="xref-link" href="chapter11.html#activation-test-and-refactoring">11.3.3 节</a>重构的成果，直接在 <code>User</code> 模型中使用 <code>User</code> 邮件程序：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="no">UserMailer</span><span class="p">.</span><span class="nf">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_now</span>
</code></pre></div>
</div>
<p>让这个邮件程序运作起来所需的代码几乎与 <a class="xref-link" href="chapter11.html#account-activation-emails">11.2 节</a>的账户激活邮件程序一样。我们首先在 <code>UserMailer</code> 中定义 <code>password_reset</code> 方法（<a class="xref-link" href="#listing-mail-password-reset">代码清单 12.7</a>），然后编写邮件的纯文本视图（<a class="xref-link" href="#listing-password-reset-text">代码清单 12.8</a>）和 HTML 视图（<a class="xref-link" href="#listing-password-reset-html">代码清单 12.9</a>）。</p>
<div id="listing-mail-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.7</span>：发送密码重设链接</h5>

<div class="source-file">app/mailers/user_mailer.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">mail</span> <span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s2">"Account activation"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span></span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s2">"Password reset"</span></span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div id="listing-password-reset-text" data-type="listing">
<h5><span class="title-label">代码清单 12.8</span>：密码重设邮件的纯文本视图</h5>

<div class="source-file">app/views/user_mailer/password_reset.text.erb</div>

<div class="highlight language-erb"><pre><code>To reset your password click the link below:

<span class="cp">&lt;%=</span> <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">,</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span> <span class="cp">%&gt;</span>

This link will expire in two hours.

If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
</code></pre></div>
</div>
<div id="listing-password-reset-html" data-type="listing">
<h5><span class="title-label">代码清单 12.9</span>：密码重设邮件的 HTML 视图</h5>

<div class="source-file">app/views/user_mailer/password_reset.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="nt">&lt;h1&gt;</span>Password reset<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span>To reset your password click the link below:<span class="nt">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Reset password"</span><span class="p">,</span> <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">,</span>
                                                      <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;p&gt;</span>This link will expire in two hours.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
<span class="nt">&lt;/p&gt;</span>
</code></pre></div>
</div>
<p>与账户激活邮件一样（<a class="xref-link" href="chapter11.html#account-activation-emails">11.2 节</a>），我们可以使用 Rails 提供的邮件预览程序预览密码重设邮件。参照<a class="xref-link" href="chapter11.html#listing-account-activation-preview">代码清单 11.18</a>，密码重设邮件的预览程序如<a class="xref-link" href="#listing-password-reset-preview">代码清单 12.10</a> 所示。</p>
<div id="listing-password-reset-preview" data-type="listing">
<h5><span class="title-label">代码清单 12.10</span>：预览密码重设邮件所需的方法</h5>

<div class="source-file">test/mailers/previews/user_mailer_preview.rb</div>

<div class="highlight language-ruby"><pre><code><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_token</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span></span>
    <span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_token</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>然后就可以预览密码重设邮件了，HTML 格式和纯文本格式分别如<a class="xref-link" href="#fig-password-reset-html-preview">图 12.8</a> 和<a class="xref-link" href="#fig-password-reset-text-preview">图 12.9</a> 所示。</p>
<div id="fig-password-reset-html-preview" class="figure"><img src="images/chapter12/password_reset_html_preview_4th_ed.png" alt="password reset html preview 4th ed" /><div class="figcaption"><span class="title-label">图 12.8</span>：预览 HTML 格式的密码重设邮件</div></div>
<p>现在，提交有效的电子邮件地址后会看到如<a class="xref-link" href="#fig-valid-email-password-reset">图 12.10</a> 所示的页面。服务器日志中会显示相应的邮件，如<a class="xref-link" href="#listing-password-reset-email">代码清单 12.11</a> 所示。</p>
<div id="fig-password-reset-text-preview" class="figure"><img src="images/chapter12/password_reset_text_preview_4th_ed.png" alt="password reset text preview 4th ed" /><div class="figcaption"><span class="title-label">图 12.9</span>：预览纯文本格式的密码重设邮件</div></div>
<div id="fig-valid-email-password-reset" class="figure"><img src="images/chapter12/valid_email_password_reset.png" alt="valid email password reset" /><div class="figcaption"><span class="title-label">图 12.10</span>：提交有效电子邮件地址后看到的页面</div></div>
<div id="listing-password-reset-email" data-type="listing">
<h5><span class="title-label">代码清单 12.11</span>：服务器日志中看到的密码重设邮件</h5>


<div class="highlight language-text"><pre><code>Sent mail to michael@michaelhartl.com (66.8ms)
Date: Mon, 06 Jun 2016 22:00:41 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;5407babbee139_8722b257d04576a@mhartl-rails-tutorial-953753.mail&gt;
Subject: Password reset
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5407babbe3505_8722b257d045617";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5407babbe3505_8722b257d045617
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

To reset your password click the link below:

https://rails-tutorial-mhartl.c9users.io/password_resets/3BdBrXeQZSWqFIDRN8cxHA/
edit?email=michael%40michaelhartl.com

This link will expire in two hours.

If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
----==_mimepart_5407babbe3505_8722b257d045617
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;h1&gt;Password reset&lt;/h1&gt;

&lt;p&gt;To reset your password click the link below:&lt;/p&gt;

&lt;a href="https://rails-tutorial-mhartl.c9users.io/
password_resets/3BdBrXeQZSWqFIDRN8cxHA/
edit?email=michael%40michaelhartl.com"&gt;Reset password&lt;/a&gt;

&lt;p&gt;This link will expire in two hours.&lt;/p&gt;

&lt;p&gt;
If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
&lt;/p&gt;
----==_mimepart_5407babbe3505_8722b257d045617--
</code></pre></div>
</div>
<h5 id="exercises-password-reset-mailer" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在浏览器中预览电子邮件模板。你看到的发送日期是什么？</p>
</li>
<li>
<p>在请求重设密码表单中提交有效的电子邮件地址，在服务器日志中会看到什么？</p>
</li>
<li>
<p>在 Rails 控制台中查找前一题中那个电子邮件地址对应的用户对象，确认它有 <code>reset_digest</code> 和 <code>reset_sent_at</code> 属性。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="reset-email-tests">
<h2><span class="title-label">12.2.2</span> 测试电子邮件</h2>
<p>参照账户激活邮件程序的测试（<a class="xref-link" href="chapter11.html#listing-real-account-activation-test">代码清单 11.20</a>），下面为密码重设邮件程序编写一个测试，如<a class="xref-link" href="#listing-password-reset-mailer-test">代码清单 12.12</a> 所示。</p>
<div id="listing-password-reset-mailer-test" data-type="listing">
<h5><span class="title-label">代码清单 12.12</span>：添加密码重设邮件程序的测试 <span class="green">GREEN</span></h5>

<div class="source-file">test/mailers/user_mailer_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_token</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s2">"noreply@example.com"</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>               <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="p">.</span><span class="nf">activation_token</span><span class="p">,</span>   <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">),</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password_reset"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_token</span></span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Password reset"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s2">"noreply@example.com"</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">,</span>        <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">),</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>现在，测试组件应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 12.13</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-reset-email-tests" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>只运行邮件程序的测试，能通过吗？</p>
</li>
<li>
<p>把<a class="xref-link" href="#listing-password-reset-mailer-test">代码清单 12.12</a> 中第二个测试里的 <code>CGI.escape</code> 去掉，确认测试会失败。</p>
</li>
</ol>
</section>
</section>
<section data-type="sect1" id="resetting-the-password">
<h1><span class="title-label">12.3</span> 重设密码</h1>
<p>现在能正确生成邮件了（<a class="xref-link" href="#listing-password-reset-email">代码清单 12.11</a>），接下来我们要编写 <code>PasswordResets</code> 控制器的 <code>edit</code> 动作，重设用户的密码。与 <a class="xref-link" href="chapter11.html#activation-test-and-refactoring">11.3.3 节</a>一样，我们将编写完整的集成测试。</p>
<section data-type="sect2" id="reset-edit-action">
<h2><span class="title-label">12.3.1</span> <code>PasswordResets</code> 控制器的 <code>edit</code> 动作</h2>
<p>密码重设邮件中有类似下面这种形式的链接：</p>
<div data-type="listing">


<div class="highlight language-text"><pre><code>https://example.com/password_resets/3BdBrXeQZSWqFIDRN8cxHA/edit?email=foo%40bar.com
</code></pre></div>
</div>
<p>为了让这种形式的链接生效，我们要编写一个表单，重设密码。这个表单的目的与编辑用户资料的表单（<a class="xref-link" href="chapter10.html#listing-user-edit-view">代码清单 10.2</a>）类似，不过现在只需更新密码和密码确认两个字段。</p>
<p>不过，这一次处理起来有点复杂，因为我们希望通过电子邮件地址查找用户。也就是说，在 <code>edit</code> 动作和 <code>update</code> 动作中都需要使用邮件地址。在 <code>edit</code> 动作中可以轻易地获取邮件地址，因为链接中有。可是提交表单后，邮件地址就没有了。为了解决这个问题，我们可以使用一个隐藏字段，把它的值设为邮件地址（不会显示），和表单中的其他数据一起提交给 <code>update</code> 动作，如<a class="xref-link" href="#listing-password-reset-form">代码清单 12.14</a> 所示。</p>
<div id="listing-password-reset-form" data-type="listing">
<h5><span class="title-label">代码清单 12.14</span>：重设密码的表单</h5>

<div class="source-file">app/views/password_resets/edit.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Reset password'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Reset password<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">url: </span><span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="cp">%&gt;</span></span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Update password"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<p>注意，在<a class="xref-link" href="#listing-password-reset-form">代码清单 12.14</a> 中，使用的表单标签辅助方法是</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><code>hidden_field_tag :email, @user.email
</code></pre></div>
</div>
<p>而不是</p>
<div data-type="listing">

<pre class="highlight language-erb"><code>f.hidden_field :email, @user.email</code></pre>
</div>
<p>因为在重设密码的链接中，邮件地址在 <code>params[:email]</code> 中，如果使用后者，会把邮件地址放入 <code>params[:user][:email]</code> 中。</p>
<p>为了正确渲染这个表单，我们要在 <code>PasswordResets</code> 控制器的 <code>edit</code> 动作中定义 <code>@user</code> 变量。与账户激活一样（<a class="xref-link" href="chapter11.html#listing-account-activation-edit-action">代码清单 11.31</a>），我们要找到 <code>params[:email]</code> 中电子邮件地址对应的用户，确认这个用户已经激活，然后使用<a class="xref-link" href="chapter11.html#listing-generalized-authenticated-p">代码清单 11.26</a> 中定义的通用版 <code>authenticated?</code> 方法验证 <code>params[:id]</code> 中的重设令牌。因为在 <code>edit</code> 和 <code>update</code> 动作中都要使用 <code>@user</code>，所以我们要把查找用户和验证令牌的代码写入一个前置过滤器中，如<a class="xref-link" href="#listing-password-reset-edit-action">代码清单 12.15</a> 所示。</p>
<div id="listing-password-reset-edit-action" data-type="listing">
<h5><span class="title-label">代码清单 12.15</span>：<code>PasswordResets</code> 控制器的 <code>edit</code> 动作</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:get_user</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span></span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:valid_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span></span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">edit</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">get_user</span>
<span class="hll">      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span></span>
    <span class="k">end</span>

    <span class="c1"># 确保是有效用户</span>
    <span class="k">def</span> <span class="nf">valid_user</span>
<span class="hll">      <span class="k">unless</span> <span class="p">(</span><span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">activated?</span> <span class="o">&amp;&amp;</span></span>
<span class="hll">              <span class="vi">@user</span><span class="p">.</span><span class="nf">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]))</span></span>
<span class="hll">        <span class="n">redirect_to</span> <span class="n">root_url</span></span>
<span class="hll">      <span class="k">end</span></span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="#listing-password-reset-edit-action">代码清单 12.15</a> 中的 <code>authenticated?(:reset, params[:id])</code>，<a class="xref-link" href="chapter11.html#listing-generalized-current-user">代码清单 11.28</a> 中的 <code>authenticated?(:remember, cookies[:remember_token])</code>，以及<a class="xref-link" href="chapter11.html#listing-account-activation-edit-action">代码清单 11.31</a> 中的 <code>authenticated?(:activation, params[:id])</code>，就是<a class="xref-link" href="chapter11.html#table-password-token-digest">表 11.1</a> 中 <code>authenticated?</code> 方法的三个用例。</p>
<p>现在，点击<a class="xref-link" href="#listing-password-reset-email">代码清单 12.11</a> 中的链接后，会显示密码重设表单，如<a class="xref-link" href="#fig-password-reset-form">图 12.11</a> 所示。</p>
<div id="fig-password-reset-form" class="figure"><img src="images/chapter12/password_reset_form.png" alt="password reset form" /><div class="figcaption"><span class="title-label">图 12.11</span>：密码重设表单</div></div>
<h5 id="exercises-reset-edit-action" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>点击服务器日志中的密码重设链接，看能不能正确渲染如<a class="xref-link" href="#fig-password-reset-form">图 12.11</a> 所示的表单。</p>
</li>
<li>
<p>提交前一题看到的表单会发生什么？</p>
</li>
</ol>
</section>
<section data-type="sect2" id="updating-the-reset">
<h2><span class="title-label">12.3.2</span> 更新密码</h2>
<p><code>AccountActivations</code> 控制器的 <code>edit</code> 动作只需把用户的状态由“未激活”改成“激活”，而 <code>PasswordResets</code> 控制器的 <code>edit</code> 动作处理的是表单，因此提交后要交给 <code>update</code> 动作处理。为了定义 <code>update</code> 动作，我们要考虑四种情况：</p>
<ol class="arabic">
<li>
<p>密码重设请求已过期</p>
</li>
<li>
<p>填写的新密码无效，更新失败</p>
</li>
<li>
<p>没有填写密码和密码确认，更新失败（看起来像是成功了）</p>
</li>
<li>
<p>成功更新密码</p>
</li>
</ol>
<p>第一第二和第四种情况非常简单，第三种情况不是那么直观，下面会详述。</p>
<p>第一种情况在 <code>edit</code> 和 <code>update</code> 动作中都要考虑，因此可以使用前置过滤器：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">before_action</span> <span class="ss">:check_expiration</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>    <span class="c1"># 第一种情况</span>
</code></pre></div>
</div>
<p>为此，我们要定义私有的 <code>check_expiration</code> 方法：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="c1"># 检查重设令牌是否过期</span>
<span class="k">def</span> <span class="nf">check_expiration</span>
  <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">password_reset_expired?</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:danger</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Password reset has expired."</span>
    <span class="n">redirect_to</span> <span class="n">new_password_reset_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>在 <code>check_expiration</code> 方法中，我们把过期检查交给实例方法 <code>password_reset_expired?</code> 去做。这个方法有点难定义，稍后再讲。</p>
<p><a class="xref-link" href="#listing-password-reset-update-action">代码清单 12.16</a> 给出了这两个过滤器的实现，还给出了涵盖第二第三和第四种情况的 <code>update</code> 动作。第二种情况会导致更新失败，然后重新渲染 <code>edit</code> 视图，显示错误消息（使用<a class="xref-link" href="#listing-password-reset-form">代码清单 12.14</a> 中共用的局部视图）。第四种情况是成功更新密码，处理方式与成功登录类似（<a class="xref-link" href="chapter8.html#listing-login-upon-signup">代码清单 8.25</a>）。</p>
<p>第二种情况没有处理密码为空（即第三种情况），而现在 <code>User</code> 模型允许密码为空（<a class="xref-link" href="chapter10.html#listing-allow-blank-password">代码清单 10.13</a>），所以我们要捕获这个问题，然后单独处理。<sup>[<a id="fn-ref-2" href="#fn-2">2</a>]</sup>为了处理这种情况，我们使用 <code>errors.add</code> 方法直接为 <code>@user</code> 对象添加错误消息：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:blank</span><span class="p">)</span>
</code></pre></div>
</div>
<p>密码为空时，上述代码使用没有内容时的默认消息。<sup>[<a id="fn-ref-3" href="#fn-3">3</a>]</sup></p>
<p>综上，处理四种情况的 <code>update</code> 动作如<a class="xref-link" href="#listing-password-reset-update-action">代码清单 12.16</a> 所示。</p>
<div id="listing-password-reset-update-action" data-type="listing">
<h5><span class="title-label">代码清单 12.16</span>：重设密码的 <code>update</code> 动作</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:get_user</span><span class="p">,</span>         <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="ss">:valid_user</span><span class="p">,</span>       <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:check_expiration</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>    <span class="c1"># 第一种情况</span></span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:password_reset</span><span class="p">][</span><span class="ss">:email</span><span class="p">].</span><span class="nf">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">create_reset_digest</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">send_password_reset_email</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:info</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Email sent with password reset instructions"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">.</span><span class="nf">now</span><span class="p">[</span><span class="ss">:danger</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Email address not found"</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
<span class="hll">    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:password</span><span class="p">].</span><span class="nf">empty?</span>                  <span class="c1"># 第三种情况</span></span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="s2">"can't be empty"</span><span class="p">)</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
<span class="hll">    <span class="k">elsif</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>          <span class="c1"># 第四种情况</span></span>
      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Password has been reset."</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">render</span> <span class="s1">'edit'</span>                                     <span class="c1"># 第二种情况</span></span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
<span class="hll">      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span></span>
    <span class="k">end</span>

    <span class="c1"># 前置过滤器</span>

    <span class="k">def</span> <span class="nf">get_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="c1"># 确保是有效用户</span>
    <span class="k">def</span> <span class="nf">valid_user</span>
      <span class="k">unless</span> <span class="p">(</span><span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">activated?</span> <span class="o">&amp;&amp;</span>
              <span class="vi">@user</span><span class="p">.</span><span class="nf">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]))</span>
        <span class="n">redirect_to</span> <span class="n">root_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># 检查重设令牌是否过期</span>
<span class="hll">    <span class="k">def</span> <span class="nf">check_expiration</span></span>
      <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">password_reset_expired?</span>
        <span class="n">flash</span><span class="p">[</span><span class="ss">:danger</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Password reset has expired."</span>
        <span class="n">redirect_to</span> <span class="n">new_password_reset_url</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>注意，我们在 <code>user_params</code> 方法中指定允许修改 <code>password</code> 和 <code>password_confirmation</code> 两个属性。</p>
<p>前面说过，我们把密码重设超时检查交给 <code>User</code> 模型去做：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="vi">@user</span><span class="p">.</span><span class="nf">password_reset_expired?</span>
</code></pre></div>
</div>
<p>所以，我们要定义 <code>password_reset_expired?</code> 方法。如 <a class="xref-link" href="#password-reset-mailer">12.2.1 节</a>的邮件模板所示，如果邮件发出后两个小时内没重设密码，就认为此次请求超时了。这个限制可以通过下面的 Ruby 代码实现：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">ago</span>
</code></pre></div>
</div>
<p>如果你把 <code>&lt;</code> 当成小于号，读成“密码重设邮件发出少于两小时”就错了，这和想表达的意思正好相反。这里，最好把 <code>&lt;</code> 理解成“超过”，读成“密码重设邮件已经发出超过两小时”，这才是我们想表达的意思。<code>password_reset_expired?</code> 方法的定义如<a class="xref-link" href="#listing-user-model-password-reset-expired">代码清单 12.17</a> 所示。（对这个比较算式的证明参见 <a class="xref-link" href="#proof-of-expiration-comparison">12.6 节</a>。）</p>
<div id="listing-user-model-password-reset-expired" data-type="listing">
<h5><span class="title-label">代码清单 12.17</span>：在 <code>User</code> 模型中定义 <code>password_reset_expired?</code> 方法</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
  <span class="c1"># 如果密码重设请求超时了，返回 true</span>
  <span class="k">def</span> <span class="nf">password_reset_expired?</span>
<span class="hll">    <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">ago</span></span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>现在，<a class="xref-link" href="#listing-password-reset-update-action">代码清单 12.16</a> 中的 <code>update</code> 动作可以使用了。密码重设失败和成功后显示的页面分别如<a class="xref-link" href="#fig-password-reset-failure">图 12.12</a> 和<a class="xref-link" href="#fig-password-reset-success">图 12.13</a> 所示。（你可能不想等两个小时再确认效果，<a class="xref-link" href="#exercises-updating-the-reset">本节的练习</a>中有一题，为第三个分支编写测试。）</p>
<h5 id="exercises-updating-the-reset" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>打开邮件中的链接，在页面中填写不一致的密码，会看到什么错误消息？</p>
</li>
<li>
<p>在 Rails 控制台中找到邮件中链接对应的用户，获取 <code>password_digest</code> 属性的值。然后在如<a class="xref-link" href="#fig-password-reset-failure">图 12.12</a> 所示的表单中填写匹配的密码，提交后有什么效果？对 <code>password_digest</code> 属性的值有什么影响？提示：使用 <code>user.reload</code> 方法加载新值。</p>
</li>
</ol>
<div id="fig-password-reset-failure" class="figure"><img src="images/chapter12/password_reset_failure_4th_ed.png" alt="password reset failure 4th ed" /><div class="figcaption"><span class="title-label">图 12.12</span>：密码重设失败</div></div>
<div id="fig-password-reset-success" class="figure"><img src="images/chapter12/password_reset_success_4th_ed.png" alt="password reset success 4th ed" /><div class="figcaption"><span class="title-label">图 12.13</span>：密码重设成功</div></div>
</section>
<section data-type="sect2" id="password-reset-test">
<h2><span class="title-label">12.3.3</span> 测试密码重设功能</h2>
<p>本节，我们要编写一个集成测试，覆盖<a class="xref-link" href="#listing-password-reset-update-action">代码清单 12.16</a> 中的两个分支：重设失败和重设成功。（前面说过，第三个分支的测试留作练习。）首先，为重设密码功能生成一个测试文件：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails generate integration_test password_resets
      invoke  test_unit
      create    <span class="nb">test</span>/integration/password_resets_test.rb
</code></pre></div>
</div>
<p>这个测试的步骤大致与<a class="xref-link" href="chapter11.html#listing-signup-with-account-activation-test">代码清单 11.33</a> 中的账户激活测试差不多，不过开头有点不同。首先访问“Forgot password”表单，分别提交有效和无效的电子邮件地址，电子邮件地址有效时要创建密码重设令牌，并且发送重设邮件。然后，访问邮件中的链接，分别提交无效和有效的密码，验证各自的行为是否正确。最终写出的测试如<a class="xref-link" href="#listing-password-reset-integration-test">代码清单 12.18</a> 所示。这是一个不错的练习，可以锻炼阅读代码的能力。</p>
<div id="listing-password-reset-integration-test" data-type="listing">
<h5><span class="title-label">代码清单 12.18</span>：密码重设功能的集成测试</h5>

<div class="source-file">test/integration/password_resets_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">PasswordResetsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">deliveries</span><span class="p">.</span><span class="nf">clear</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password resets"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">new_password_reset_path</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/new'</span>
    <span class="c1"># 电子邮件地址无效</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">password_reset: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/new'</span>
    <span class="c1"># 电子邮件地址有效</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span>
         <span class="ss">params: </span><span class="p">{</span> <span class="ss">password_reset: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_not_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">reset_digest</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">reset_digest</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">deliveries</span><span class="p">.</span><span class="nf">size</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 密码重设表单</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="c1"># 电子邮件地址错误</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">""</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 用户未激活</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">toggle!</span><span class="p">(</span><span class="ss">:activated</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">,</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">toggle!</span><span class="p">(</span><span class="ss">:activated</span><span class="p">)</span>
    <span class="c1"># 电子邮件地址正确，令牌不对</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="s1">'wrong token'</span><span class="p">,</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 电子邮件地址正确，令牌也对</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">,</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/edit'</span>
    <span class="n">assert_select</span> <span class="s2">"input[name=email][type=hidden][value=?]"</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">email</span>
    <span class="c1"># 密码和密码确认不匹配</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
                    <span class="ss">user: </span><span class="p">{</span> <span class="ss">password:              </span><span class="s2">"foobaz"</span><span class="p">,</span>
                            <span class="ss">password_confirmation: </span><span class="s2">"barquux"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 密码为空值</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
                    <span class="ss">user: </span><span class="p">{</span> <span class="ss">password:              </span><span class="s2">""</span><span class="p">,</span>
                            <span class="ss">password_confirmation: </span><span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 密码和密码确认有效</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
                    <span class="ss">user: </span><span class="p">{</span> <span class="ss">password:              </span><span class="s2">"foobaz"</span><span class="p">,</span>
                            <span class="ss">password_confirmation: </span><span class="s2">"foobaz"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="#listing-password-reset-integration-test">代码清单 12.18</a> 中的大多数用法前面都见过，但是针对 <code>input</code> 标签的测试有点陌生：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">assert_select</span> <span class="s2">"input[name=email][type=hidden][value=?]"</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">email</span>
</code></pre></div>
</div>
<p>这行代码的意思是，页面中有 <code>name</code> 属性、类型（隐藏）和电子邮件地址都正确的 <code>input</code> 标签：</p>
<div data-type="listing">


<div class="highlight language-html"><pre><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"email"</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"michael@example.com"</span> <span class="nt">/&gt;</span>
</code></pre></div>
</div>
<p>现在，测试组件应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 12.19</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-password-reset-test" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在<a class="xref-link" href="#listing-user-model-password-reset">代码清单 12.6</a> 中，<code>create_reset_digest</code> 方法调用了两次 <code>update_attribute</code> 方法，每一次调用都要单独执行一个数据库事务。填写<a class="xref-link" href="#listing-update-columns-redux">代码清单 12.20</a> 中缺少的代码，把两个 <code>update_attribute</code> 调用换成一个 <code>update_columns</code> 调用，这样修改后只会与数据库交互一次。改完后运行测试组件，确保仍能通过。（<a class="xref-link" href="#listing-update-columns-redux">代码清单 12.20</a> 中包含<a class="xref-link" href="chapter11.html#listing-update-columns">代码清单 11.39</a> 的解答。）</p>
</li>
<li>
<p>填写<a class="xref-link" href="#listing-password-reset-expire-test">代码清单 12.21</a> 中缺少的代码，为<a class="xref-link" href="#listing-password-reset-update-action">代码清单 12.16</a> 中的密码重设请求超时分支编写集成测试。（这里使用的 <code>response.body</code> 用于获取返回页面中的 HTML。）检查是否过期有很多方法，这里使用的方法是，检查响应主体中是否包含单词“expired”（不区分大小写）。</p>
</li>
<li>
<p>几小时后让密码重设请求过期是个不错的安全防护措施，可是对使用公共电脑的用户来说，安全隐患更大。这是因为密码重设链接的有效期是 2 小时，而在这段时间内，即便用户已经退出，重设链接仍能使用。如果用户在公共电脑上重设密码，任何人都能点击后退按钮，然后再次重设密码（从而使用新密码登录）。为了避免这个问题，添加<a class="xref-link" href="#listing-update-clear-reset">代码清单 12.22</a> 中的代码，在用户成功修改密码后清除重设摘要。<sup>[<a id="fn-ref-4" href="#fn-4">4</a>]</sup></p>
</li>
<li>
<p>在<a class="xref-link" href="#listing-password-reset-integration-test">代码清单 12.18</a> 中添加一行代码，测试前一题实现的重设摘要清除功能。提示：使用 <code>assert_nil</code> 和 <code>user.reload</code> 直接测试 <code>reset_digest</code> 属性。</p>
</li>
</ol>
<div id="listing-update-columns-redux" data-type="listing">
<h5><span class="title-label">代码清单 12.20</span>：使用 <code>update_columns</code> 的代码模板</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span>
  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
  <span class="c1"># 激活账户</span>
  <span class="k">def</span> <span class="nf">activate</span>
    <span class="n">update_columns</span><span class="p">(</span><span class="ss">activated: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">activated_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 发送激活邮件</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_now</span>
  <span class="k">end</span>

  <span class="c1"># 设置密码重设相关的属性</span>
  <span class="k">def</span> <span class="nf">create_reset_digest</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_token</span>
<span class="hll">    <span class="n">update_columns</span><span class="p">(</span><span class="ss">reset_digest:  </span><span class="no">FILL_IN</span><span class="p">,</span> <span class="ss">reset_sent_at: </span><span class="no">FILL_IN</span><span class="p">)</span></span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<div id="listing-password-reset-expire-test" data-type="listing">
<h5><span class="title-label">代码清单 12.21</span>：测试密码重设请求超时 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/password_resets_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">PasswordResetsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">deliveries</span><span class="p">.</span><span class="nf">clear</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"expired token"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">new_password_reset_path</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span>
         <span class="ss">params: </span><span class="p">{</span> <span class="ss">password_reset: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">}</span>

    <span class="vi">@user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attribute</span><span class="p">(</span><span class="ss">:reset_sent_at</span><span class="p">,</span> <span class="mi">3</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">reset_token</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
                    <span class="ss">user: </span><span class="p">{</span> <span class="ss">password:              </span><span class="s2">"foobar"</span><span class="p">,</span>
                            <span class="ss">password_confirmation: </span><span class="s2">"foobar"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_response</span> <span class="ss">:redirect</span>
    <span class="n">follow_redirect!</span>
<span class="hll">    <span class="n">assert_match</span> <span class="sr">/FILL_IN/i</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span></span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div id="listing-update-clear-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.22</span>：成功重设密码后清除重设摘要</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">update</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:password</span><span class="p">].</span><span class="nf">empty?</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="s2">"can't be empty"</span><span class="p">)</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">elsif</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="vi">@user</span>
<span class="hll">      <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attribute</span><span class="p">(</span><span class="ss">:reset_digest</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span></span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Password has been reset."</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
</section>
</section>
<section data-type="sect1" id="email-in-production-take-two">
<h1><span class="title-label">12.4</span> 在生产环境中发送邮件（再谈）</h1>
<p>我们已经在开发环境实现了密码重设功能，本节要配置应用，让它在生产环境中能真正地发送邮件。相关的步骤与实现账户激活功能时一样，如果你已经按照 <a class="xref-link" href="chapter11.html#email-in-production">11.4 节</a>所讲的做了，可以直接跳到<a class="xref-link" href="#listing-merge-password-reset">代码清单 12.24</a>。</p>
<p>我们要在生产环境中使用 SendGrid 服务发送邮件。这个服务是 Heroku 的扩展，只有通过认证的账户才能使用。（要在 Heroku 的账户中填写信用卡信息，不过认证不收费。）对我们的应用来说，入门套餐就够了（免费，写作本书时限制每天最多发送 400 封邮件）。我们可以使用下面的命令添加这个扩展：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>heroku addons:create sendgrid:starter
</code></pre></div>
</div>
<p>（如果你使用的是 Heroku 的旧版命令行接口，这个命令可能无法执行。这个问题有两种解决方法：其一，<a href="https://toolbelt.heroku.com/" class="external-link">升级到最新的 Heroku 工具包</a>；其二，使用旧句法 <code>heroku addons:add sendgrid:starter</code>。）</p>
<p>为了让应用使用 SendGrid 发送邮件，我们要在生产环境中配置 <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol" class="external-link">SMTP</a>，还要定义一个 <code>host</code> 变量，设置生产环境中网站的地址，如<a class="xref-link" href="#listing-sendgrid-config-redux">代码清单 12.23</a> 所示。</p>
<div id="listing-sendgrid-config-redux" data-type="listing">
<h5><span class="title-label">代码清单 12.23</span>：配置应用，在生产环境中使用 SendGrid</h5>

<div class="source-file">config/environments/production.rb</div>

<div class="highlight language-ruby"><pre><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'&lt;your heroku app&gt;.herokuapp.com'</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host: </span><span class="n">host</span> <span class="p">}</span>
  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:address</span>        <span class="o">=&gt;</span> <span class="s1">'smtp.sendgrid.net'</span><span class="p">,</span>
    <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
    <span class="ss">:user_name</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'SENDGRID_USERNAME'</span><span class="p">],</span>
    <span class="ss">:password</span>       <span class="o">=&gt;</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'SENDGRID_PASSWORD'</span><span class="p">],</span>
    <span class="ss">:domain</span>         <span class="o">=&gt;</span> <span class="s1">'heroku.com'</span><span class="p">,</span>
    <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="p">}</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="#listing-sendgrid-config-redux">代码清单 12.23</a> 中设置了 SendGrid 账户的用户名（<code>user_name</code>）和密码（<code>password</code>），但是注意，这两个值是从 <code>ENV</code> 环境变量中获取的，而没有直接写入代码。这是生产环境应用的最佳实践，为了安全，绝不能在源码中写入敏感信息，例如原始密码。这两个值由 SendGrid 扩展自动设置，<a class="xref-link" href="chapter13.html#image-upload-in-production">13.4.4 节</a>会介绍如何自己定义。</p>
<p>现在，应该把主题分支合并到主分支中：</p>
<div id="listing-merge-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 12.24</span>：把 <code>password-reset</code> 分支合并到 <code>master</code> 分支</h5>


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails <span class="nb">test</span>
<span class="gp">$ </span>git add -A
<span class="gp">$ </span>git commit -m <span class="s2">"Add password reset"</span>
<span class="gp">$ </span>git checkout master
<span class="gp">$ </span>git merge password-reset
</code></pre></div>
</div>
<p>然后，推送到远程仓库，再部署到 Heroku：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="gp">$ </span>rails <span class="nb">test</span>
<span class="gp">$ </span>git push
<span class="gp">$ </span>git push heroku
<span class="gp">$ </span>heroku run rails db:migrate
</code></pre></div>
</div>
<p>部署到 Heroku 中之后，可以点击“forgot password”链接（<a class="xref-link" href="#fig-forgot-password-link">图 12.4</a>）重设密码。你会收到一封重设邮件，如<a class="xref-link" href="#fig-reset-email-production">图 12.14</a> 所示。点击邮件中的链接，输入有效密码或无效密码，效果应该同生产环境中一样（<a class="xref-link" href="#fig-password-reset-failure">图 12.12</a> 和<a class="xref-link" href="#fig-password-reset-success">图 12.13</a>）。</p>
<div id="fig-reset-email-production" class="figure has-border"><img src="images/chapter12/reset_email_production_4th_ed.png" alt="reset email production 4th ed" /><div class="figcaption"><span class="title-label">图 12.14</span>：生产环境中的应用发送的密码重设邮件</div></div>
<h5 id="exercises-email-in-production" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在生产环境中重设密码。能收到电子邮件吗？</p>
</li>
<li>
<p>点击密码重设邮件中的链接，然后重设密码。在服务器的日志中能看到什么？提示：在命令行中执行 <code>heroku logs</code> 命令。</p>
</li>
<li>
<p>你能成功更新密码吗？</p>
</li>
</ol>
</section>
<section data-type="sect1" id="password-reset-conclusion">
<h1><span class="title-label">12.5</span> 小结</h1>
<p>实现密码重设功能后，我们的演示应用已经完整实现了“注册-登录-退出”机制，而且是专业级的。本书剩下的章节将以此为基础，实现类似 Twitter 的微博（<a class="xref-link" href="chapter13.html#user-microposts">第 13 章</a>）和所关注用户的微博动态流（<a class="xref-link" href="chapter14.html#following-users">第 14 章</a>）。在实现的过程中，我们会学到一些 Rails 提供的强大功能，例如使用 <code>has_many</code> 和 <code>has_many :through</code> 实现的高级数据模型。</p>
<section data-type="sect2" id="password-reset-learned">
<h2><span class="title-label">12.5.1</span> 本章所学</h2>
<ul>
<li>
<p>与会话和账户激活一样，密码重设虽然没有对应的 Active Record 对象，但也可以看做一个资源；</p>
</li>
<li>
<p>Rails 可以生成 Action Mailer 动作和视图，用于发送邮件；</p>
</li>
<li>
<p>Action Mailer 支持纯文本邮件和 HTML 邮件；</p>
</li>
<li>
<p>与普通的动作和视图一样，在邮件程序的视图中也可以使用邮件程序动作中的实例变量；</p>
</li>
<li>
<p>使用生成的令牌创建唯一的 URL，用于重设密码；</p>
</li>
<li>
<p>使用哈希摘要安全识别有效的密码重设请求；</p>
</li>
<li>
<p>邮件程序的测试和集成测试对确认邮件程序的行为都有用；</p>
</li>
<li>
<p>在生产环境可以使用 SendGrid 发送电子邮件。</p>
</li>
</ul>
</section>
</section>
<section data-type="sect1" id="proof-of-expiration-comparison">
<h1><span class="title-label">12.6</span> 证明超时比较算式</h1>
<p>我们在 <a class="xref-link" href="#resetting-the-password">12.3 节</a>讲过，确定密码重设请求是否超时的比较算式是：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">ago</span>
</code></pre></div>
</div>
<p>乍一看容易理解成“密码重设邮件发出少于两小时”，这和想表达的意思正好相反。本节我们要证明这个比较算式是正确的。</p>
<p>我们先来定义两个时间间隔：<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="4ex" height="2.5ex" viewbox="0 -739.9 1691.5 1063.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E2-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E2-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E2-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E2-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E2-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-3B3" x="517" y="-213"></use>
</g>
</g>
</svg>
 表示发送密码重设邮件后经过的时间，<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="3.833ex" height="2.167ex" viewbox="0 -739.9 1637 918.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E2-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E2-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E2-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E2-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E2-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>
 表示限制的失效时长（例如两个小时）。如果邮件发出后经过的时间比限制的失效时长长，说明此次密码重设请求已经失效，即：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.773ex" height="2.843ex" style="vertical-align: -1.005ex;" viewbox="0 -791.3 4638.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(833,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="511" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="1957" y="0"></use>
 <use xlink:href="#E1-MJMAIN-394" x="3013" y="0"></use>
<g transform="translate(3846,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="511" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>如果用 <svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="2.5ex" height="1.833ex" viewbox="0 -649.9 1097.4 820.9" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
</svg>
表示现在的时间，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.964ex" height="2.676ex" style="vertical-align: -1.005ex;" viewbox="0 -719.6 845.8 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="511" y="-213"></use>
</g>
</svg>
 表示发送邮件的时间，<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="1.833ex" height="2ex" viewbox="0 -649.9 799 828.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</svg>
 表示失效的时间（例如两个小时以前），那么：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.335ex" height="2.843ex" style="vertical-align: -1.005ex;" viewbox="0 -791.3 6171.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(833,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="511" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="1957" y="0"></use>
<g transform="translate(3013,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="511" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="4325" y="0"></use>
<g transform="translate(5326,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="511" y="-213"></use>
</g>
</g>
</svg>

</div>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="14.167ex" height="2.167ex" viewbox="0 -739.9 6099.5 918.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="1914" y="0"></use>
<g transform="translate(2975,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="4295" y="0"></use>
<g transform="translate(5300,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>把这两个等式代入第一个算式：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.773ex" height="2.843ex" style="vertical-align: -1.005ex;" viewbox="0 -791.3 4638.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(833,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="511" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="1957" y="0"></use>
 <use xlink:href="#E1-MJMAIN-394" x="3013" y="0"></use>
<g transform="translate(3846,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="511" y="-213"></use>
</g>
</g>
</svg>

</div>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="17.667ex" height="2.333ex" viewbox="0 -649.9 7640.9 973.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2212" x="1319" y="0"></use>
<g transform="translate(2324,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="3456" y="0"></use>
<g transform="translate(4516,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="5836" y="0"></use>
<g transform="translate(6841,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="10.667ex" height="2.333ex" viewbox="0 -649.9 4557.1 973.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2212" x="0" y="0"></use>
<g transform="translate(783,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="1914" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2212" x="2975" y="0"></use>
<g transform="translate(3758,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>在这个不等式的两边乘于 -1 后得到：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="7ex" height="2.333ex" viewbox="0 -649.9 2991.1 973.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-3C" x="1131" y="0"></use>
<g transform="translate(2192,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>把 <svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="1.833ex" height="2ex" viewbox="0 -649.9 799 828.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</svg>
 = 2.hours.ago 代入这个不等式后就能得到<a class="xref-link" href="#listing-user-model-password-reset-expired">代码清单 12.17</a> 中的 <code>password_reset_expired?</code> 方法：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="k">def</span> <span class="nf">password_reset_expired?</span>
  <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">ago</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="#resetting-the-password">12.3 节</a>说过，如果把 <code>&lt;</code> 理解成“超过”而不是“小于”的话，就能得到一个符合人类逻辑的句子：“密码重设邮件已经发出超过两小时”。</p>
</section>
</section>
          </article>

          <nav class="pagination">
            <ul class="pager">
              
              <li class="pager-prev"><a class="prev" href="chapter11.html" title="第 11 章 激活账户">&laquo; 第 11 章 激活账户</a></li>
              

              
              <li class="pager-next"><a class="next" href="chapter13.html" title="第 13 章 用户的微博">第 13 章 用户的微博 &raquo;</a></li>
              
            </ul>
          </nav>

          <div class="footnotes">
<ol>
<li id="fn-1">不要觉得显示电子邮件地址不安全。网上随处可见不允许使用已经被用过的电子邮件地址注册的网站，在密码重设过程中指明电子邮件不可用不会给攻击者留下可利用的信息。 <a href="#fn-ref-1" class="symbol">&#8617;</a></li>
<li id="fn-2">我们只需处理密码为空的情况，因为密码确认为空时会被二次确认验证捕获（密码为空时不会做这个验证），然后显示一个相关的错误消息。 <a href="#fn-ref-2" class="symbol">&#8617;</a></li>
<li id="fn-3">细心的读者 Khaled Teilab 发现，使用 <code>errors.add(:password, :blank)</code> 的好处是，使用 <code>rails-i18n</code> gem 时得到的消息自动使用正确的语言渲染。 <a href="#fn-ref-3" class="symbol">&#8617;</a></li>
<li id="fn-4">感谢读者 Tristan Ludowyk 提出这个建议，并且提供详细说明和实现方式。 <a href="#fn-ref-4" class="symbol">&#8617;</a></li>
</ol>
</div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p>&copy;2013-2017 <a href="http://about.ac" title="安道的个人网站" target="_blank">安道</a></p>
      <p>
        <a href="https://twitter.com/andor_chen" title="在 Twitter 中关注 @andor_chen"  target="_blank"><i class="icon-twitter"></i></a>
        <a href="http://weibo.com/andor27" title="在微博中关注 @andor_chen"  target="_blank"><i class="icon-weibo"></i></a>
      </p>
      <p>保留部分权利</p>
    </div>
  </footer>

</body>
</html>
