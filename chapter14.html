<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Ruby on Rails 教程 - 第 14 章 关注用户</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="最好的 Ruby on Rails 入门教程"/>
  <meta name="keywords" content="ruby, rails, tutorial"/>
  <meta name="author" content="Michael Hartl"/>
  <meta name="translator" content="安道"/>
  <meta name="generator" content="persie 0.0.4.1"/>
  <link rel="stylesheet" type="text/css" href="//railstutorial-china.org/assets/css/main.css"/>
  <link rel="stylesheet" type="text/css" href="book.css"/>
  <script type="text/javascript" src="//railstutorial-china.org/assets/js/global.js"></script>
</head>

<body class="book-page">

  <nav class="navbar">
    <div class="container">

      <div class="clearfix">
        <a class="navbar-brand hidden-sm-up" href="//railstutorial-china.org/" title="Ruby on Rails 教程">Ruby on Rails 教程</a>
        <button class="navbar-toggler hidden-sm-up pull-xs-right" type="button" data-toggle="collapse" data-target="#main-nav">&#9776;</button>
      </div>

      <a class="navbar-brand hidden-xs-down" href="//railstutorial-china.org/" title="Ruby on Rails 教程">Ruby on Rails 教程</a>

      <div class="collapse navbar-toggleable-xs pull-sm-right" id="main-nav">
        <ul class="nav navbar-nav">
          <li class="nav-item"><a class="nav-link" href="//railstutorial-china.org/" title="首页">首页</a></li>
          <li class="nav-item"><a class="nav-link" href="//railstutorial-china.org/blog/" title="博客">博客</a></li>
          <li class="nav-item active"><a class="nav-link" href="//railstutorial-china.org/book/" title="阅读">阅读</a></li>
          <li class="nav-item"><a class="nav-link" href="//railstutorial-china.org/#ebook" title="电子书">电子书</a></li>
        </ul>
      </div>

    </div>
  </nav>


  <div class="content">
    <div class="container">
      <div class="row">
        <div class="col-lg-offset-2 col-lg-8">
          <div class="book-versions">
            选择版本：
            <a class="btn btn-primary" href="//railstutorial-china.org/book/" title="Ruby on Rails 教程（原书第 4 版，针对 Rails 5）">Rails 5</a>
            <a class="btn btn-secondary" href="//railstutorial-china.org/rails42/" title="Ruby on Rails 教程（原书第 3 版，针对 Rails 4.2）">Rails 4.2</a>
            <a class="btn btn-secondary" href="//railstutorial-china.org/rails4/" title="Ruby on Rails 教程（原书第 3 版，针对 Rails 4.0）">Rails 4.0</a>
            <a class="btn btn-secondary" href="//railstutorial-china.org/rails3/" title="Ruby on Rails 教程（原书第 2 版，针对 Rails 3.2）">Rails 3.2</a>
          </div>

          <div class="alert alert-warning">
            <p>在线版的内容可能落后于电子书，如果想及时获得更新，请<a href="//railstutorial-china.org/#ebook" title="购买电子书">购买电子书</a>。</p>
          </div>

          <article class="article">
            <section data-type="chapter" id="following-users">
<h1><span class="title-label">第 14 章</span> 关注用户</h1>
<p>这一章，我们要为演示应用添加社交功能，允许用户关注（及取消关注）其他人，并在主页显示被关注用户发布的微博（动态流）。我们将在 <a class="xref-link" href="#the-relationship-model">14.1 节</a>学习如何建立用户之间的关系，然后在 <a class="xref-link" href="#a-web-interface-for-following-users">14.2 节</a>编写相应的 Web 界面（还会介绍 Ajax）。最后，在 <a class="xref-link" href="#the-status-feed">14.3 节</a>实现功能完善的动态流。</p>
<p>这是本书最后一章，有些内容具有挑战性。比如说，为了实现动态流，我们会使用一些 Ruby 和 SQL 技巧。通过这些示例，你将了解到 Rails 是如何处理更加复杂的数据模型的，这些知识也会在你日后开发其他应用时发挥作用。 为了帮助你平稳地从学习过渡到独立开发，<a class="xref-link" href="#following-users-conclusion">14.4 节</a>会列出一些进阶学习资源。</p>
<p>因为本章的内容比较有挑战性，所以在开始编写代码之前，我们先来讨论一下界面。和之前的章节一样，在开发之前，我们将使用构思图。<sup>[<a id="fn-ref-1" href="#fn-1">1</a>]</sup>完整的页面流程是这样的：一个用户 (John Calvin) 从他的资料页面（<a class="xref-link" href="#fig-page-flow-profile-mockup">图 14.1</a>）浏览到用户列表页面（<a class="xref-link" href="#fig-page-flow-user-index-mockup">图 14.2</a>），寻找想关注的用户；然后他打开另一个用户 Thomas Hobbes 的资料页面（<a class="xref-link" href="#fig-page-flow-other-profile-follow-button">图 14.3</a>），点击“Follow”（关注）按钮关注了他，这时“Follow”按钮会变为“Unfollow”（取消关注），而且关注 Hobbes 的人数增加了一个（<a class="xref-link" href="#fig-page-flow-other-profile-unfollow-button-mockup">图 14.4</a>）；接着，Calvin 回到主页，看到他关注的人数也增加了一个，而且在动态流中能看到 Hobbes 发布的微博（<a class="xref-link" href="#fig-page-flow-home-page-feed-mockup">图 14.5</a>）。本章接下来的内容就是要实现这样的页面流程。</p>
<div id="fig-page-flow-profile-mockup" class="figure"><img src="images/chapter14/page_flow_profile_mockup_3rd_edition.png" alt="page flow profile mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 14.1</span>：当前用户的资料页面</div></div>
<div id="fig-page-flow-user-index-mockup" class="figure"><img src="images/chapter14/page_flow_user_index_mockup_bootstrap.png" alt="page flow user index mockup bootstrap" /><div class="figcaption"><span class="title-label">图 14.2</span>：找一个想关注的用户</div></div>
<div id="fig-page-flow-other-profile-follow-button" class="figure"><img src="images/chapter14/page_flow_other_profile_follow_button_mockup_3rd_edition.png" alt="page flow other profile follow button mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 14.3</span>：想关注的那个用户的资料页面，有一个“Follow”（关注）按钮</div></div>
<div id="fig-page-flow-other-profile-unfollow-button-mockup" class="figure"><img src="images/chapter14/page_flow_other_profile_unfollow_button_mockup_3rd_edition.png" alt="page flow other profile unfollow button mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 14.4</span>：资料页面中显示了“Unfollow”（取消关注）按钮，而且关注他的人数增加了一个</div></div>
<div id="fig-page-flow-home-page-feed-mockup" class="figure"><img src="images/chapter14/page_flow_home_page_feed_mockup_3rd_edition.png" alt="page flow home page feed mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 14.5</span>：首页，显示了动态流，而且关注的人数增加了一个</div></div>
<section data-type="sect1" id="the-relationship-model">
<h1><span class="title-label">14.1</span> <code>Relationship</code> 模型</h1>
<p>为了实现用户关注功能，首先要创建一个看上去并不是那么直观的数据模型。一开始我们可能以为 <code>has_many</code> 关联能满足我们的要求：一个用户关注多个用户，而且也被多个用户关注。但实际上这种实现方式有问题，下面我们将学习如何使用 <code>has_many :through</code> 解决。</p>
<p>和之前一样，如果使用 Git，现在应该新建一个主题分支：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>git checkout <span class="nt">-b</span> following-users
</code></pre></div>
</div>
<section data-type="sect2" id="a-problem-with-the-data-model-and-a-solution">
<h2><span class="title-label">14.1.1</span> 数据模型带来的问题（以及解决方法）</h2>
<p>在构建关注用户所需的数据模型之前，我们先来分析一个典型的案例。假如一个用户关注了另外一个用户，比如 Calvin 关注了 Hobbes，也就是 Hobbes 被 Calvin 关注了，那么 Calvin 就是“关注人”（follower），Hobbes 则是“被关注人”（followed）。按照 Rails 默认的复数命名约定， 我们称关注了某个用户的所有用户为这个用户的“followers”，因此，<code>hobbes.followers</code> 是一个数组，包含所有关注了 Hobbes 的用户。不过，如果反过来，这种表述就说不通了：默认情况下，所有被关注的用户应该叫“followeds”，但是这样说并不符合英语语法。所以，参照 Twitter 的叫法，我们把被关注的用户叫做“following”（例如，“50 following, 75 followers”）。因此，Calvin 关注的人可以通过 <code>calvin.following</code> 数组获取。</p>
<p>经过上述讨论，我们可以按照<a class="xref-link" href="#fig-naive-user-has-many-following">图 14.6</a> 中的方式构建被关注用户的模型——一个 <code>following</code> 表和 <code>has_many</code> 关联。由于 <code>user.following</code> 应该是一个用户对象组成的数组，所以 <code>following</code> 表中的每一行都应该是一个用户，通过 <code>followed_id</code> 列标识，然后再通过 <code>follower_id</code> 列建立关联。<sup>[<a id="fn-ref-2" href="#fn-2">2</a>]</sup>除此之外，由于每一行都是一个用户，所以还要在表中加入用户的其他属性，例如名字、电子邮件地址和密码等。</p>
<div id="fig-naive-user-has-many-following" class="figure"><img src="images/chapter14/naive_user_has_many_following.png" alt="naive user has many following" /><div class="figcaption"><span class="title-label">图 14.6</span>：一个用户关注的人（天真方式）</div></div>
<p><a class="xref-link" href="#fig-naive-user-has-many-following">图 14.6</a> 中的数据模型有个问题：存在非常多的冗余，每一行不仅包括被关注用户的 ID，还包括他们的其他信息，而这些信息在 <code>users</code> 表中都有。 更糟的是，为了保存关注我的人，还需要另一个同样冗余的 <code>followers</code> 表。这么做会导致数据模型极难维护：用户修改名字时，不仅要修改 <code>users</code> 表中的数据，还要修改 <code>following</code> 和 <code>followers</code> 表中包含这个用户的每一条记录。</p>
<p>造成这个问题的原因是缺少底层抽象。找到合适的抽象有一种方法：思考在 Web 应用中如何实现关注用户的操作。<a class="xref-link" href="chapter7.html#a-users-resource">7.1.2 节</a>介绍过，REST 架构涉及到资源的创建和销毁两个操作。由此引出了两个问题：用户关注另一个用户时，创建的是什么？用户取消关注另一个用户时，销毁的是什么？按照这样的方式思考，我们会发现，在关注用户的过程中，创建和销毁的是两个用户之间的“关系”。因此，一个用户有多个“关系”，从而通过这个“关系”得到很多我关注的人（<code>following</code>）和关注我的人（<code>followers</code>）。</p>
<p>在实现应用的数据模型时还有一个细节要注意：Facebook 实现的关系是对称的（至少在数据模型层是），而我们要实现的关系和 Twitter 类似，是不对称的，Calvin 可以关注 Hobbes，但 Hobbes 并不需要关注 Calvin。为了区分这两种情况，我们要使用专业的术语：如果 Calvin 关注了 Hobbes，但 Hobbes 没有关注 Calvin，那么 Calvin 和 Hobbes 之间建立的是主动关系（active relationship），而 Hobbes 和 Calvin 之间是被动关系（passive relationship）。<sup>[<a id="fn-ref-3" href="#fn-3">3</a>]</sup></p>
<p>现在我们集中精力实现主动关系，即获取我关注的用户。<a class="xref-link" href="#followers">14.1.5 节</a>再实现被动关系。从<a class="xref-link" href="#fig-naive-user-has-many-following">图 14.6</a> 中可以看出实现的方式：既然我关注的每一个用户都由 <code>followed_id</code> 独一无二地标识出来了，我们就可以把 <code>following</code> 表转化成 <code>active_relationships</code> 表，删掉用户的属性，然后使用 <code>followed_id</code> 从 <code>users</code> 表中检索我关注的用户的信息。这个数据模型如<a class="xref-link" href="#fig-user-has-many-following">图 14.7</a> 所示。</p>
<div id="fig-user-has-many-following" class="figure"><img src="images/chapter14/user_has_many_following_3rd_edition.png" alt="user has many following 3rd edition" /><div class="figcaption"><span class="title-label">图 14.7</span>：通过主动关系获取我关注的用户</div></div>
<p>因为主动关系和被动关系最终会存储在同一个表中，所以我们把这个表命名为“relationships”。这个表对应的模型是 <code>Relationship</code>，如<a class="xref-link" href="#fig-relationship-model">图 14.8</a> 所示。从 <a class="xref-link" href="#followed-users">14.1.4 节</a>开始，我们将介绍如何使用这个模型同时实现主动关系和被动关系。</p>
<div id="fig-relationship-model" class="figure"><img src="images/chapter14/relationship_model.png" alt="relationship model" /><div class="figcaption"><span class="title-label">图 14.8</span>：<code>Relationship</code> 数据模型</div></div>
<p>为此，我们要生成一个迁移，对应于<a class="xref-link" href="#fig-relationship-model">图 14.8</a> 中的模型：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails generate model Relationship follower_id:integer followed_id:integer
</code></pre></div>
</div>
<p>因为我们将通过 <code>follower_id</code> 和 <code>followed_id</code> 查找关系，所以还要为这两个列建立索引，提高查询的效率，如<a class="xref-link" href="#listing-relationships-migration">代码清单 14.1</a> 所示。</p>
<div id="listing-relationships-migration" data-type="listing">
<h5><span class="title-label">代码清单 14.1</span>：在 <code>relationships</code> 表中添加索引</h5>

<div class="source-file">db/migrate/[timestamp]_create_relationships.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span></span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span></span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="p">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span></span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>在<a class="xref-link" href="#listing-relationships-migration">代码清单 14.1</a> 中，我们还设置了一个多键索引，确保 (<code>follower_id, followed_id</code>) 组合是唯一的，避免多次关注同一个用户。（可以和<a class="xref-link" href="chapter6.html#listing-email-uniqueness-index">代码清单 6.29</a> 中保持电子邮件地址唯一的索引，以及<a class="xref-link" href="chapter13.html#listing-micropost-migration">代码清单 13.3</a> 中的多键索引比较一下。）从 <a class="xref-link" href="#followed-users">14.1.4 节</a>起会看到，用户界面不会允许这样的事发生，但添加索引后，如果用户试图创建重复的关系（例如使用 <code>curl</code> 这样的命令行工具），应用会抛出异常。</p>
<p>为了创建 <code>relationships</code> 表，和之前一样，我们要迁移数据库：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails db:migrate
</code></pre></div>
</div>
<h5 id="exercises-a-problem-with-the-data-model-and-a-solution" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>对<a class="xref-link" href="#fig-user-has-many-following">图 14.7</a> 中 ID 为 1 的用户来说，<code>user.following.map(&amp;:id)</code> 的值是什么？（<a class="xref-link" href="chapter4.html#blocks">4.3.2 节</a> 介绍过 <code>map(&amp;:method_name)</code> 这种句法；<code>user.following.map(&amp;:id)</code> 返回的是 ID 组成的数组。）</p>
</li>
<li>
<p>查看<a class="xref-link" href="#fig-user-has-many-following">图 14.7</a>，对 ID 为 2 的用户来说，<code>user.following</code> 的值是什么？<code>user.following.map(&amp;:id)</code> 呢？</p>
</li>
</ol>
</section>
<section data-type="sect2" id="user-relationship-associations">
<h2><span class="title-label">14.1.2</span> <code>User</code> 模型和 <code>Relationship</code> 模型之间的关联</h2>
<p>在获取我关注的人和关注我的人之前，我们要先建立 <code>User</code> 模型和 <code>Relationship</code> 模型之间的关联。一个用户有多个“关系”（<code>has_many</code>），因为一个“关系”涉及到两个用户，所以“关系”同时属于（<code>belongs_to</code>）该用户和被关注的用户。</p>
<p>和 <a class="xref-link" href="chapter13.html#user-micropost-associations">13.1.3 节</a>创建微博的方式一样，我们要通过关联创建“关系”，如下面的代码所示：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">followed_id: </span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
</div>
<p>此时，你可能想在应用中加入类似于 <a class="xref-link" href="chapter13.html#user-micropost-associations">13.1.3 节</a>使用的代码。我们要添加的代码确实很像，但有两处不同。</p>
<p>首先，把用户和微博关联起来时我们是这么写的：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>之所以可以这么写，是因为 Rails 会寻找 <code>:microposts</code> 符号对应的模型，即 <code>Micropost</code>。<sup>[<a id="fn-ref-4" href="#fn-4">4</a>]</sup>可是现在这个模型名为 <code>Relationship</code>，而我们想写成：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">has_many</span> <span class="ss">:active_relationships</span>
</code></pre></div>
</div>
<p>所以要告诉 Rails 模型的类名。</p>
<p>其次，前面在 <code>Micropost</code> 模型中是这么写的：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>之所以可以这么写，是因为 <code>microposts</code> 表中有识别用户的 <code>user_id</code> 列（<a class="xref-link" href="chapter13.html#the-basic-model">13.1.1 节</a>）。这种连接两个表的列，我们称之为外键（foreign key）。当指向 <code>User</code> 模型的外键为 <code>user_id</code> 时，Rails 会自动获知关联，因为默认情况下，Rails 会寻找名为 <code>&lt;class&gt;_id</code> 的外键，其中 <code>&lt;class&gt;</code> 是模型类名的小写形式。<sup>[<a id="fn-ref-5" href="#fn-5">5</a>]</sup>现在，尽管我们处理的还是用户，但识别用户使用的外键是 <code>follower_id</code>，所以要告诉 Rails 这一变化。</p>
<p>综上所述，<code>User</code> 和 <code>Relationship</code> 模型之间的关联如<a class="xref-link" href="#listing-user-relationships-association">代码清单 14.2</a> 和<a class="xref-link" href="#listing-relationship-belongs-to">代码清单 14.3</a> 所示。</p>
<div id="listing-user-relationships-association" data-type="listing">
<h5><span class="title-label">代码清单 14.2</span>：实现主动关系中的 <code>has_many</code> 关联</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">class_name:  </span><span class="s2">"Relationship"</span><span class="p">,</span></span>
<span class="hll">                                  <span class="ss">foreign_key: </span><span class="s2">"follower_id"</span><span class="p">,</span></span>
<span class="hll">                                  <span class="ss">dependent:   :destroy</span></span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>（因为删除用户时也要删除涉及这个用户的“关系”，所以我们在关联中加入了 <code>dependent: :destroy</code>。）</p>
<div id="listing-relationship-belongs-to" data-type="listing">
<h5><span class="title-label">代码清单 14.3</span>：在 <code>Relationship</code> 模型中添加 <code>belongs_to</code> 关联</h5>

<div class="source-file">app/models/relationship.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span></span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span></span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>尽管 <a class="xref-link" href="#followers">14.1.5 节</a>才会用到 <code>followed</code> 关联，但同时添加易于理解。</p>
<p>建立上述关联后，会得到一系列类似于<a class="xref-link" href="chapter13.html#table-association-methods">表 13.1</a> 中的方法，如<a class="xref-link" href="#table-association-methods-relationships">表 14.1</a> 所示。</p>
<table id="table-association-methods-relationships" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 14.1</span>：<code>User</code> 模型与 <code>Relationship</code> 模型建立主动关系之后得到的方法简介</caption>
<colgroup>
<col style="width: 50%;" />
<col style="width: 50%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">方法</th>
<th class="tableblock halign-left valign-top">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>active_relationship.follower</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">获取关注我的用户</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>active_relationship.followed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">获取我关注的用户</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.active_relationships.create(followed_id: other_user.id)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">创建 <code>user</code> 发起的主动关系</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.active_relationships.create!(followed_id: other_user.id)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">创建 <code>user</code> 发起的主动关系（失败时抛出异常）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.active_relationships.build(followed_id: other_user.id)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">构建 <code>user</code> 发起的主动关系对象</p></td>
</tr>
</tbody>
</table>
<h5 id="exercises-relationship-user-associations" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>打开 Rails 控制台，使用<a class="xref-link" href="#table-association-methods-relationships">表 14.1</a> 中的 <code>create</code> 方法为数据库中的第一个用户和第二个用户建立主动关系。</p>
</li>
<li>
<p>确认 <code>active_relationship.followed</code> 和 <code>active_relationship.follower</code> 返回的值是正确的。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="relationship-validations">
<h2><span class="title-label">14.1.3</span> 数据验证</h2>
<p>在继续之前，我们要在 <code>Relationship</code> 模型中添加一些验证。测试（<a class="xref-link" href="#listing-relationship-validation-tests">代码清单 14.4</a>）和应用代码（<a class="xref-link" href="#listing-relationship-validations">代码清单 14.5</a>）都非常直观。与生成的用户固件一样（<a class="xref-link" href="chapter6.html#listing-default-fixtures">代码清单 6.30</a>），生成的“关系”固件也违背了迁移中的唯一性约束（<a class="xref-link" href="#listing-relationships-migration">代码清单 14.1</a>）。这个问题的解决方法也和之前一样（<a class="xref-link" href="chapter6.html#listing-empty-fixtures">代码清单 6.31</a>）——删除自动生成的固件，如<a class="xref-link" href="#listing-empty-relationship-fixture">代码清单 14.6</a> 所示。</p>
<div id="listing-relationship-validation-tests" data-type="listing">
<h5><span class="title-label">代码清单 14.4</span>：测试 <code>Relationship</code> 模型中的验证</h5>

<div class="source-file">test/models/relationship_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">RelationshipTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@relationship</span> <span class="o">=</span> <span class="no">Relationship</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">follower_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span>
                                     <span class="ss">followed_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@relationship</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should require a follower_id"</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="p">.</span><span class="nf">follower_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@relationship</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should require a followed_id"</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="p">.</span><span class="nf">followed_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@relationship</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div id="listing-relationship-validations" data-type="listing">
<h5><span class="title-label">代码清单 14.5</span>：在 <code>Relationship</code> 模型中添加验证</h5>

<div class="source-file">app/models/relationship.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span></span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span></span>
<span class="k">end</span>
</code></pre></div>
</div>
<div id="listing-empty-relationship-fixture" data-type="listing">
<h5><span class="title-label">代码清单 14.6</span>：删除“关系”固件</h5>

<div class="source-file">test/fixtures/relationships.yml</div>

<div class="highlight language-yaml"><pre><code><span class="c1"># empty</span>
</code></pre></div>
</div>
<p>现在，测试应该可以通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.7</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-relationship-validations" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>把<a class="xref-link" href="#listing-relationship-validations">代码清单 14.5</a> 中的验证注释掉，确认测试仍能通过。（这是 Rails 5 的变化，在之前的 Rails 版本中，必须添加那两个验证。为了明确表明意图，我们会留着验证。不过你要知道这一点，以防其他人编写的代码中没有这两个验证。）</p>
</li>
</ol>
</section>
<section data-type="sect2" id="followed-users">
<h2><span class="title-label">14.1.4</span> 我关注的用户</h2>
<p>现在到“关系”的核心部分了——获取我关注的用户（<code>following</code>）和关注我的用户（<code>followers</code>）。这里我们要首次用到 <code>has_many :through</code> 关联：用户通过 <code>Relationship</code> 模型关注多个用户，如<a class="xref-link" href="#fig-user-has-many-following">图 14.7</a> 所示。默认情况下，在 <code>has_many :through</code> 关联中，Rails 会寻找关联名单数形式对应的外键。例如：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through: :active_relationships</span>
</code></pre></div>
</div>
<p>Rails 发现关联名是“followeds”，先把它变成单数形式“followed”，然后在 <code>relationships</code> 表中获取一个由 <code>followed_id</code> 组成的集合。不过，<a class="xref-link" href="#a-problem-with-the-data-model-and-a-solution">14.1.1 节</a>说过，写成 <code>user.followeds</code> 有点说不通，所以我们会使用 <code>user.following</code>。Rails 允许定制默认生成的关联方法：使用 <code>source</code> 参数指定 <code>following</code> 数组由 <code>followed_id</code> 组成，如<a class="xref-link" href="#listing-has-many-following-through-active-relationships">代码清单 14.8</a> 所示。</p>
<div id="listing-has-many-following-through-active-relationships" data-type="listing">
<h5><span class="title-label">代码清单 14.8</span>：在 <code>User</code> 模型中添加 <code>following</code> 关联</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">class_name:  </span><span class="s2">"Relationship"</span><span class="p">,</span>
                                  <span class="ss">foreign_key: </span><span class="s2">"follower_id"</span><span class="p">,</span>
                                  <span class="ss">dependent:   :destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through: :active_relationships</span><span class="p">,</span> <span class="ss">source: :followed</span></span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>定义这个关联后，我们可以充分利用 Active Record 和数组的功能。例如，可以使用 <code>include?</code> 方法（<a class="xref-link" href="chapter4.html#arrays-and-ranges">4.3.1 节</a>）检查我关注的用户中有没有某个用户，或者通过关联查找一个用户：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</code></pre></div>
</div>
<p>还可以像数组那样添加和删除元素：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">user</span><span class="p">.</span><span class="nf">following</span> <span class="o">&lt;&lt;</span> <span class="n">other_user</span>
<span class="n">user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</code></pre></div>
</div>
<p>（<a class="xref-link" href="chapter4.html#arrays-and-ranges">4.3.1 节</a>说过，<code>&lt;&lt;</code> 运算符把元素添加到数组末尾。）</p>
<p>很多情况下都可以把 <code>following</code> 当成数组来用，Rails 会使用特定的方式处理 <code>following</code>，所以这么做很高效。例如：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">following</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</code></pre></div>
</div>
<p>这看起来好像是要把我关注的所有用户都从数据库中读取出来，然后再调用 <code>include?</code>。其实不然，为了提高效率，Rails 会直接在数据库层执行相关的操作。（和 <a class="xref-link" href="chapter13.html#rendering-microposts">13.2.1 节</a>使用 <code>user.microposts.count</code> 获取数量一样，都直接在数据库中操作。）</p>
<p>为了处理关注用户的操作，我们要定义两个辅助方法：<code>follow</code> 和 <code>unfollow</code>。这样我们就可以写 <code>user.follow(other_user)</code>。我们还要定义 <code>following?</code> 布尔值方法，检查一个用户是否关注了另一个用户。<sup>[<a id="fn-ref-6" href="#fn-6">6</a>]</sup></p>
<p>现在是编写测试的好时机，因为我们还要等很久才会开发关注用户的网页界面，如果一直没人监管，很难向前推进。我们可以为 <code>User</code> 模型编写一个简短的测试，先调用 <code>following?</code> 方法确认某个用户没有关注另一个用户，然后调用 <code>follow</code> 方法关注那个用户，再使用 <code>following?</code> 方法确认关注成功了，最后调用 <code>unfollow</code> 方法取消关注，并确认操作成功，如<a class="xref-link" href="#listing-utility-method-tests">代码清单 14.9</a> 所示。</p>
<div id="listing-utility-method-tests" data-type="listing">
<h5><span class="title-label">代码清单 14.9</span>：测试关注用户相关的几个辅助方法 <span class="red">RED</span></h5>

<div class="source-file">test/models/user_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"should follow and unfollow a user"</span> <span class="k">do</span>
    <span class="n">michael</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="p">.</span><span class="nf">follow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">michael</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="p">.</span><span class="nf">unfollow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>把 <code>following</code> 关联视作对象，可以像<a class="xref-link" href="#listing-follow-unfollow-following">代码清单 14.10</a> 那样定义 <code>follow</code>、<code>unfollow</code> 和 <code>following?</code> 三个方法。（注意，只要可能，我们就省略 <code>self</code>。）</p>
<div id="listing-follow-unfollow-following" data-type="listing">
<h5><span class="title-label">代码清单 14.10</span>：定义关注用户相关的几个辅助方法 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">feed</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
  <span class="nf">end</span>

  <span class="c1"># 关注另一个用户</span>
  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span> <span class="o">&lt;&lt;</span> <span class="n">other_user</span></span>
  <span class="k">end</span>

  <span class="c1"># 取消关注另一个用户</span>
  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span></span>
  <span class="k">end</span>

  <span class="c1"># 如果当前用户关注了指定的用户，返回 true</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span></span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>现在，测试能通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.11</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-following" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在 Rails 控制台中重现<a class="xref-link" href="#listing-utility-method-tests">代码清单 14.9</a> 中的步骤。</p>
</li>
<li>
<p>前一题中各个操作对应的 SQL 语句是什么？</p>
</li>
</ol>
</section>
<section data-type="sect2" id="followers">
<h2><span class="title-label">14.1.5</span> 关注我的人</h2>
<p>“关系”的最后一部分是定义与 <code>user.following</code> 对应的 <code>user.followers</code> 方法。从<a class="xref-link" href="#fig-user-has-many-following">图 14.7</a> 中得知，获取关注我的人所需的数据都已经存在于 <code>relationships</code> 表中（我们要参照<a class="xref-link" href="#listing-user-relationships-association">代码清单 14.2</a> 中实现 <code>active_relationships</code> 表的方式）。其实我们要使用的方法和实现我关注的人一样，只要对调 <code>follower_id</code> 和 <code>followed_id</code> 的位置，并把 <code>active_relationships</code> 换成 <code>passive_relationships</code> 即可，如<a class="xref-link" href="#fig-user-has-many-followers">图 14.9</a> 所示。</p>
<div id="fig-user-has-many-followers" class="figure"><img src="images/chapter14/user_has_many_followers_3rd_edition.png" alt="user has many followers 3rd edition" /><div class="figcaption"><span class="title-label">图 14.9</span>：通过被动关系获取关注我的用户</div></div>
<p>参照<a class="xref-link" href="#listing-has-many-following-through-active-relationships">代码清单 14.8</a>，我们可以使用<a class="xref-link" href="#listing-has-many-following-through-passive-relationships">代码清单 14.12</a> 中的代码实现<a class="xref-link" href="#fig-user-has-many-followers">图 14.9</a> 中的模型。</p>
<div id="listing-has-many-following-through-passive-relationships" data-type="listing">
<h5><span class="title-label">代码清单 14.12</span>：使用被动关系实现 <code>user.followers</code></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">class_name:  </span><span class="s2">"Relationship"</span><span class="p">,</span>
                                   <span class="ss">foreign_key: </span><span class="s2">"follower_id"</span><span class="p">,</span>
                                   <span class="ss">dependent:   :destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">class_name:  </span><span class="s2">"Relationship"</span><span class="p">,</span></span>
<span class="hll">                                   <span class="ss">foreign_key: </span><span class="s2">"followed_id"</span><span class="p">,</span></span>
<span class="hll">                                   <span class="ss">dependent:   :destroy</span></span>
  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through: :active_relationships</span><span class="p">,</span>  <span class="ss">source: :followed</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through: :passive_relationships</span><span class="p">,</span> <span class="ss">source: :follower</span></span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>值得注意的是，其实我们可以省略 <code>followers</code> 关联中的 <code>source</code> 参数，直接写成：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through: :passive_relationships</span>
</code></pre></div>
</div>
<p>因为 Rails 会把“followers”转换成单数“follower”，然后查找名为 <code>follower_id</code> 的外键。<a class="xref-link" href="#listing-has-many-following-through-passive-relationships">代码清单 14.12</a> 之所以保留了 <code>source</code> 参数，是为了和 <code>has_many :following</code> 关联的结构保持一致。</p>
<p>我们可以使用 <code>followers.include?</code> 测试这个数据模型，如<a class="xref-link" href="#listing-followers-test">代码清单 14.13</a> 所示。（这段测试本可以使用与 <code>following?</code> 方法对应的 <code>followed_by?</code> 方法，但应用中用不到，所以我们没这么做。）</p>
<div id="listing-followers-test" data-type="listing">
<h5><span class="title-label">代码清单 14.13</span>：测试 <code>followers</code> 关联 <span class="green">GREEN</span></h5>

<div class="source-file">test/models/user_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"should follow and unfollow a user"</span> <span class="k">do</span>
    <span class="n">michael</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>   <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="p">.</span><span class="nf">follow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">michael</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
<span class="hll">    <span class="n">assert</span> <span class="n">archer</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">michael</span><span class="p">)</span></span>
    <span class="n">michael</span><span class="p">.</span><span class="nf">unfollow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>我们只在<a class="xref-link" href="#listing-utility-method-tests">代码清单 14.9</a> 的基础上增加了一行代码，但若想让这个测试通过，很多事情都要正确处理才行，这足以测试<a class="xref-link" href="#listing-has-many-following-through-passive-relationships">代码清单 14.12</a> 中的关联。</p>
<p>现在，整个测试组件都能通过：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-followers" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在 Rails 控制台中为数据库中的第一个用户（赋值给 <code>user</code> 变量）添加几个关注者，<code>user.followers.map(:id)</code> 的值是什么？</p>
</li>
<li>
<p>确认 <code>user.followers.count</code> 的值与你在前一题中添加的关注者数量一样。</p>
</li>
<li>
<p><code>user.followers.count</code> 对应的 SQL 语句是什么？与 <code>user.followers.to_a.count</code> 有什么区别？提示：假设这个用户有一百万个关注者。</p>
</li>
</ol>
</section>
</section>
<section data-type="sect1" id="a-web-interface-for-following-users">
<h1><span class="title-label">14.2</span> 关注用户的网页界面</h1>
<p><a class="xref-link" href="#the-relationship-model">14.1 节</a>用到了很多数据模型技术，可能要花些时间才能完全理解。其实，理解这些关联最好的方式是在网页界面中使用。</p>
<p>在本章的导言中，我们介绍了关注用户的操作流程。本节，我们要实现这些构思的页面，以及关注和取消关注功能。我们还会创建两个页面，分别列出我关注的用户和关注我的用户。在 <a class="xref-link" href="#the-status-feed">14.3 节</a>，我们会实现用户的动态流，届时，这个演示应用才算完成。</p>
<section data-type="sect2" id="sample-following-data">
<h2><span class="title-label">14.2.1</span> 示例数据</h2>
<p>和之前的几章一样，我们要使用 <code>rails db:seed</code> 命令把“关系”相关的种子数据加载到数据库中。有了示例数据，我们就可以先实现网页界面，本节末尾再实现后端功能。</p>
<p>“关系”相关的种子数据如<a class="xref-link" href="#listing-sample-relationships">代码清单 14.14</a> 所示。我们让第一个用户关注第 3-51 个用户，让第 4-41 个用户关注第一个用户。这样的数据足够用来开发应用的界面了。</p>
<div id="listing-sample-relationships" data-type="listing">
<h5><span class="title-label">代码清单 14.14</span>：在种子数据中添加“关系”相关的数据</h5>

<div class="source-file">db/seeds.rb</div>

<div class="highlight language-yaml"><pre><code><span class="c1"># Users</span>
<span class="s">User.create!(name</span><span class="pi">:</span>  <span class="s2">"</span><span class="s">Example</span><span class="nv"> </span><span class="s">User"</span><span class="err">,</span>
             <span class="na">email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example@railstutorial.org"</span><span class="err">,</span>
             <span class="na">password</span><span class="pi">:</span>              <span class="s2">"</span><span class="s">foobar"</span><span class="err">,</span>
             <span class="na">password_confirmation</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foobar"</span><span class="err">,</span>
             <span class="na">admin</span><span class="pi">:</span>     <span class="no">true</span><span class="s">,</span>
             <span class="na">activated</span><span class="pi">:</span> <span class="no">true</span><span class="s">,</span>
             <span class="na">activated_at</span><span class="pi">:</span> <span class="s">Time.zone.now)</span>

<span class="s">99.times do |n|</span>
  <span class="s">name  = Faker::Name.name</span>
  <span class="s">email = "example-#{n+1}@railstutorial.org"</span>
  <span class="s">password = "password"</span>
  <span class="s">User.create!(name</span><span class="pi">:</span> <span class="s">name,</span>
              <span class="s">email</span><span class="pi">:</span> <span class="s">email,</span>
              <span class="s">password</span><span class="pi">:</span>              <span class="s">password,</span>
              <span class="s">password_confirmation</span><span class="pi">:</span> <span class="s">password,</span>
              <span class="s">activated</span><span class="pi">:</span> <span class="no">true</span><span class="s">,</span>
              <span class="s">activated_at</span><span class="pi">:</span> <span class="s">Time.zone.now)</span>
<span class="s">end</span>

<span class="c1"># Microposts</span>
<span class="s">users = User.order(:created_at).take(6)</span>
<span class="s">50.times do</span>
  <span class="s">content = Faker::Lorem.sentence(5)</span>
  <span class="s">users.each { |user| user.microposts.create!(content</span><span class="pi">:</span> <span class="s">content) }</span>
<span class="s">end</span>

<span class="hll"><span class="c1"># Following relationships</span></span>
<span class="hll"><span class="s">users = User.all</span></span>
<span class="hll"><span class="s">user  = users.first</span></span>
<span class="hll"><span class="s">following = users[2..50]</span></span>
<span class="hll"><span class="s">followers = users[3..40]</span></span>
<span class="hll"><span class="s">following.each { |followed| user.follow(followed) }</span></span>
<span class="hll"><span class="s">followers.each { |follower| follower.follow(user) }</span></span>
</code></pre></div>
</div>
<p>然后像之前一样，执行下面的命令，重置数据库之后重新加载种子数据：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails db:migrate:reset
<span class="nv">$ </span>rails db:seed
</code></pre></div>
</div>
<h5 id="exercises-sample-following-data" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在 Rails 控制台中确认 <code>User.first.followers.count</code> 的值与<a class="xref-link" href="#listing-sample-relationships">代码清单 14.14</a> 设定的一样。</p>
</li>
<li>
<p>确认 <code>User.first.following.count</code> 的值也正确。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="stats-and-a-follow-form">
<h2><span class="title-label">14.2.2</span> 数量统计和关注表单</h2>
<p>现在示例用户已经关注了其他用户，也被其他用户关注了，我们要更新一下用户资料页面和首页，把这些变动显示出来。首先，我们要创建一个局部视图，在资料页面和首页显示我关注的人和关注我的人的数量。然后再添加关注和取消关注表单，并且在专门的页面中列出我关注的用户和关注我的用户。</p>
<p><a class="xref-link" href="#a-problem-with-the-data-model-and-a-solution">14.1.1 节</a>说过，我们参照了 Twitter 的叫法，在我关注的用户数量后使用“following”作标注，例如“50 following”。<a class="xref-link" href="#fig-page-flow-profile-mockup">图 14.1</a> 中的构思图就使用了这种表述方式，现在把这部分单独摘出来，如<a class="xref-link" href="#fig-stats-partial-mockup">图 14.10</a> 所示。</p>
<div id="fig-stats-partial-mockup" class="figure"><img src="images/chapter14/stats_partial_mockup.png" alt="stats partial mockup" /><div class="figcaption"><span class="title-label">图 14.10</span>：数量统计局部视图的构思图</div></div>
<p><a class="xref-link" href="#fig-stats-partial-mockup">图 14.10</a> 中显示的数量统计包含当前用户关注的人数和关注当前用户的人数，而且分别链接到专门的用户列表页面。在<a class="xref-link" href="chapter5.html#filling-in-the-layout">第 5 章</a>，我们使用 <code>#</code> 占位符代替真实的网址，因为那时我们还没怎么接触路由。现在，虽然 <a class="xref-link" href="#following-and-followers-pages">14.2.3 节</a>才会创建所需的页面，不过可以先设置路由，如<a class="xref-link" href="#listing-following-followers-actions-routes">代码清单 14.15</a> 所示。这段代码在 <code>resources</code> 块中使用了 <code>:member</code> 方法。我们以前没用过这个方法，你可以猜一下这个方法的作用是什么。</p>
<div id="listing-following-followers-actions-routes" data-type="listing">
<h5><span class="title-label">代码清单 14.15</span>：在 <code>Users</code> 控制器中添加 <code>following</code> 和 <code>followers</code> 两个动作</h5>

<div class="source-file">config/routes.rb</div>

<div class="highlight language-ruby"><pre><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span>   <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to: </span><span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to: </span><span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to: </span><span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to: </span><span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to: </span><span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'/logout'</span><span class="p">,</span>  <span class="ss">to: </span><span class="s1">'sessions#destroy'</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span></span>
<span class="hll">    <span class="n">member</span> <span class="k">do</span></span>
<span class="hll">      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span></span>
<span class="hll">    <span class="k">end</span></span>
<span class="hll">  <span class="k">end</span></span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only: </span><span class="p">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>你可能猜到了，设定上述路由后，得到的 URL 地址类似 /users/1/following 和 /users/1/followers 这种形式。不错，<a class="xref-link" href="#listing-following-followers-actions-routes">代码清单 14.15</a> 的作用确实如此。因为这两个页面都是用来显示数据的，所以我们使用了 <code>get</code> 方法，指定这两个地址响应的是 GET 请求。而且，使用 <code>member</code> 方法后，这两个动作对应的 URL 地址中都会包含用户的 ID。除此之外，我们还可以使用 <code>collection</code> 方法，但这样 URL 中就没有用户 ID 了。所以，如下的代码</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>得到的 URL 是 /users/tigers（或许可以用来显示应用中所有的老虎）。<sup>[<a id="fn-ref-7" href="#fn-7">7</a>]</sup></p>
<p><a class="xref-link" href="#listing-following-followers-actions-routes">代码清单 14.15</a> 生成的路由如<a class="xref-link" href="#table-following-routes">表 14.2</a> 所示。留意一下我关注的用户页面和关注我的用户页面的具名路由是什么，稍后会用到。</p>
<table id="table-following-routes" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 14.2</span>：<a class="xref-link" href="#listing-following-followers-actions-routes">代码清单 14.15</a> 中设置的规则生成的 REST 路由</caption>
<colgroup>
<col style="width: 15%;" />
<col style="width: 20%;" />
<col style="width: 15%;" />
<col style="width: 50%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HTTP 请求</th>
<th class="tableblock halign-left valign-top">URL</th>
<th class="tableblock halign-left valign-top">动作</th>
<th class="tableblock halign-left valign-top">具名路由</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/users/1/following</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>following</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>following_user_path(1)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/users/1/followers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>followers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>followers_user_path(1)</code></p></td>
</tr>
</tbody>
</table>
<p>设好了路由后，我们来编写数量统计局部视图。我们要在一个 <code>div</code> 元素中显示几个链接，如<a class="xref-link" href="#listing-stats-partial">代码清单 14.16</a> 所示。</p>
<div id="listing-stats-partial" data-type="listing">
<h5><span class="title-label">代码清单 14.16</span>：显示数量统计的局部视图</h5>

<div class="source-file">app/views/shared/_stats.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"followers"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<p>因为用户资料页面和首页都要使用这个局部视图，所以在<a class="xref-link" href="#listing-stats-partial">代码清单 14.16</a> 的第一行，我们要获取正确的用户对象：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<p>我们在<a class="xref-link" href="chapter8.html#aside-or-equals">旁注 8.1</a>中介绍过这种用法，如果 <code>@user</code> 不是 <code>nil</code>（在用户资料页面），这行代码没什么效果；如果是 <code>nil</code>（在首页），就会把当前用户赋值给 <code>@user</code>。还有一处要注意，我关注的人数和关注我的人数是通过关联获取的，分别使用 <code>@user.following.count</code> 和 <code>@user.followers.count</code>。</p>
<p>我们可以和<a class="xref-link" href="chapter13.html#listing-user-show-microposts">代码清单 13.24</a> 中获取微博数量的代码对比一下，微博的数量通过 <code>@user.microposts.count</code> 获取。为了提高效率，Rails 会直接在数据库层统计数量。</p>
<p>最后还有一个细节需要注意，我们为某些元素指定了 CSS ID，例如：</p>
<div data-type="listing">


<div class="highlight language-html"><pre><code><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</code></pre></div>
</div>
<p>这些 ID 是为 <a class="xref-link" href="#a-working-follow-button-with-ajax">14.2.5 节</a>中的 Ajax 准备的，因为 Ajax 要通过独一无二的 ID 获取页面中的元素。</p>
<p>编写好局部视图，把它放入首页就很简单了，如<a class="xref-link" href="#listing-home-page-stats">代码清单 14.17</a> 所示。</p>
<div id="listing-home-page-stats" data-type="listing">
<h5><span class="title-label">代码清单 14.17</span>：在首页显示数量统计</h5>

<div class="source-file">app/views/static_pages/home.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
<span class="hll">      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span></span>
<span class="hll">        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span></span>
<span class="hll">      <span class="nt">&lt;/section&gt;</span></span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"micropost_form"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<p>我们要添加一些 SCSS 代码，美化数量统计，如<a class="xref-link" href="#listing-stats-css">代码清单 14.18</a> 所示（包含本章用到的所有样式）。添加样式后，首页如<a class="xref-link" href="#fig-home-page-follow-stats">图 14.11</a> 所示。</p>
<div id="listing-stats-css" data-type="listing">
<h5><span class="title-label">代码清单 14.18</span>：首页侧边栏的 SCSS 样式</h5>

<div class="source-file">app/assets/stylesheets/custom.scss</div>

<div class="highlight language-scss"><pre><code><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
  <span class="nl">margin-right</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.gravatar_edit</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">15px</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.stats</span> <span class="p">{</span></span>
  <span class="nl">overflow</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">10px</span><span class="p">;</span>
    <span class="nl">border-left</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="nv">$gray-lighter</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="no">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="nl">padding-left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
      <span class="nl">border</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
      <span class="nl">color</span><span class="p">:</span> <span class="no">blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.user_avatars</span> <span class="p">{</span></span>
  <span class="nl">overflow</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">1px</span> <span class="m">1px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.users.follow</span> <span class="p">{</span></span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forms */</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</code></pre></div>
</div>
<div id="fig-home-page-follow-stats" class="figure"><img src="images/chapter14/home_page_follow_stats_3rd_edition.png" alt="home page follow stats 3rd edition" /><div class="figcaption"><span class="title-label">图 14.11</span>：显示有数量统计的首页</div></div>
<p>稍后再把数量统计局部视图添加到用户资料页面中，现在先来编写关注和取消关注按钮的局部视图，如<a class="xref-link" href="#listing-follow-form-partial">代码清单 14.19</a> 所示。</p>
<div id="listing-follow-form-partial" data-type="listing">
<h5><span class="title-label">代码清单 14.19</span>：显示关注或取消关注表单的局部视图</h5>

<div class="source-file">app/views/users/_follow_form.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"follow_form"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'unfollow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<p>这段代码其实也没做什么，只是把具体的工作委托给 <code>follow</code> 和 <code>unfollow</code> 局部视图了。我们要再次设置路由，加入 <code>Relationships</code> 资源，如<a class="xref-link" href="#listing-relationships-resource">代码清单 14.20</a> 所示，这与 <code>Microposts</code> 资源的设置类似（<a class="xref-link" href="chapter13.html#listing-microposts-resource">代码清单 13.30</a>）。</p>
<div id="listing-relationships-resource" data-type="listing">
<h5><span class="title-label">代码清单 14.20</span>：添加 <code>Relationships</code> 资源的路由规则</h5>

<div class="source-file">config/routes.rb</div>

<div class="highlight language-ruby"><pre><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only: </span><span class="p">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span>       <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span></span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><code>follow</code> 和 <code>unfollow</code> 局部视图的代码分别如<a class="xref-link" href="#listing-follow-form">代码清单 14.21</a> 和<a class="xref-link" href="#listing-unfollow-form">代码清单 14.22</a> 所示。</p>
<div id="listing-follow-form" data-type="listing">
<h5><span class="title-label">代码清单 14.21</span>：关注用户的表单</h5>

<div class="source-file">app/views/users/_follow.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">build</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<div id="listing-unfollow-form" data-type="listing">
<h5><span class="title-label">代码清单 14.22</span>：取消关注用户的表单</h5>

<div class="source-file">app/views/users/_unfollow.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">followed_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">),</span>
             <span class="ss">html: </span><span class="p">{</span> <span class="ss">method: :delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<p>这两个表单都使用 <code>form_for</code> 处理 <code>Relationship</code> 模型对象，二者之间主要的不同是，<a class="xref-link" href="#listing-follow-form">代码清单 14.21</a> 用于构建一个新“关系”，而<a class="xref-link" href="#listing-unfollow-form">代码清单 14.22</a> 查找现有的“关系”。很显然，第一个表单会向 <code>Relationships</code> 控制器的 <code>create</code> 动作发送 <code>POST</code> 请求，创建“关系”；而第二个表单向 <code>destroy</code> 动作发送 <code>DELETE</code> 请求，销毁“关系”。（这两个动作在 <a class="xref-link" href="#a-working-follow-button-the-standard-way">14.2.4 节</a>编写。）你可能还注意到了，关注用户的表单中除了按钮之外什么内容也没有，但是仍然要把 <code>followed_id</code> 发送给控制器。在<a class="xref-link" href="#listing-follow-form">代码清单 14.21</a> 中，我们使用 <code>hidden_field_tag</code> 方法把 <code>followed_id</code> 添加到表单中，生成的 HTML 如下：</p>
<div data-type="listing">


<div class="highlight language-html"><pre><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"followed_id"</span> <span class="na">name=</span><span class="s">"followed_id"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="chapter12.html#resetting-the-password">12.3 节</a>说过，隐藏的 <code>input</code> 标签会把所需的信息包含在表单中，但在浏览器中不显示。</p>
<p>现在我们可以在资料页面中加入关注表单和数量统计了，如<a class="xref-link" href="#listing-user-follow-form-profile-stats">代码清单 14.23</a> 所示，只需渲染相应的局部视图即可。显示有关注按钮和取消关注按钮的用户资料页面分别如<a class="xref-link" href="#fig-profile-follow-button">图 14.12</a> 和<a class="xref-link" href="#fig-profile-unfollow-button">图 14.13</a> 所示。</p>
<div id="listing-user-follow-form-profile-stats" data-type="listing">
<h5><span class="title-label">代码清单 14.23</span>：在用户资料页面加入关注表单和数量统计</h5>

<div class="source-file">app/views/users/show.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
<span class="hll">    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span></span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span></span>
<span class="hll">    <span class="nt">&lt;/section&gt;</span></span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow_form'</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span></span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<p>稍后我们会让这些按钮起作用，而且将使用两种方式实现，一种是常规方式（<a class="xref-link" href="#a-working-follow-button-the-standard-way">14.2.4 节</a>），另一种使用 Ajax（<a class="xref-link" href="#a-working-follow-button-with-ajax">14.2.5 节</a>）。不过在此之前，我们要创建剩下的页面——我关注的用户列表页面和关注我的用户列表页面。</p>
<h5 id="exercises-stats-and-a-follow-form" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>确认 /users/2 页面有关注按钮，/users/5 页面有取消关注按钮。/users/1 页面有关注按钮吗？</p>
</li>
<li>
<p>在浏览器中确认首页和资料页面有数量统计。</p>
</li>
<li>
<p>为首页中的数量统计编写测试。提示：把测试添加到<a class="xref-link" href="chapter13.html#listing-user-profile-test">代码清单 13.28</a> 中。为什么不用再测试资料页面的数量统计了？</p>
</li>
</ol>
<div id="fig-profile-follow-button" class="figure"><img src="images/chapter14/profile_follow_button_3rd_edition.png" alt="profile follow button 3rd edition" /><div class="figcaption"><span class="title-label">图 14.12</span>：某个用户的资料页面（/users/2），显示有关注按钮</div></div>
<div id="fig-profile-unfollow-button" class="figure"><img src="images/chapter14/profile_unfollow_button_3rd_edition.png" alt="profile unfollow button 3rd edition" /><div class="figcaption"><span class="title-label">图 14.13</span>：某个用户的资料页面（/users/5），显示有取消关注按钮</div></div>
</section>
<section data-type="sect2" id="following-and-followers-pages">
<h2><span class="title-label">14.2.3</span> 我关注的用户列表页面和关注我的用户列表页面</h2>
<p>我关注的用户列表页面和关注我的用户列表页面是资料页面和用户列表页面的混合体，在侧边栏显示用户的信息（包括数量统计），再列出一系列用户。除此之外，还会在侧边栏中显示一个用户头像列表。构思图如<a class="xref-link" href="#fig-following-mockup">图 14.14</a>（我关注的用户）和<a class="xref-link" href="#fig-followers-mockup">图 14.15</a>（关注我的用户）所示。</p>
<div id="fig-following-mockup" class="figure"><img src="images/chapter14/following_mockup_bootstrap.png" alt="following mockup bootstrap" /><div class="figcaption"><span class="title-label">图 14.14</span>：我关注的用户列表页面构思图</div></div>
<div id="fig-followers-mockup" class="figure"><img src="images/chapter14/followers_mockup_bootstrap.png" alt="followers mockup bootstrap" /><div class="figcaption"><span class="title-label">图 14.15</span>：关注我的用户列表页面构思图</div></div>
<p>首先，我们要让这两个页面的地址可访问。按照 Twitter 的方式，访问这两个页面都需要先登录。我们要先编写测试，参照以前的访问限制测试，写出的测试如<a class="xref-link" href="#listing-following-followers-authorization-test">代码清单 14.24</a> 所示。注意，<a class="xref-link" href="#listing-following-followers-authorization-test">代码清单 14.24</a> 用到了<a class="xref-link" href="#table-following-routes">表 14.2</a> 中的具名路由。</p>
<div id="listing-following-followers-authorization-test" data-type="listing">
<h5><span class="title-label">代码清单 14.24</span>：测试我关注的用户列表页面和关注我的用户列表页面的访问限制</h5>

<div class="source-file">test/controllers/users_controller_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"should redirect following when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect followers when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>在实现这两个页面的过程中，唯一很难想到的是，我们要在 <code>Users</code> 控制器中添加相应的两个动作。按照<a class="xref-link" href="#listing-following-followers-actions-routes">代码清单 14.15</a> 中的路由规则，这两个动作应该命名为 <code>following</code> 和 <code>followers</code>。在这两个动作中，需要设置页面的标题、查找用户，获取 <code>@user.followed_users</code> 或 <code>@user.followers</code>（要分页显示），然后再渲染页面，如<a class="xref-link" href="#listing-following-followers-actions">代码清单 14.25</a> 所示。</p>
<div id="listing-following-followers-actions" data-type="listing">
<h5><span class="title-label">代码清单 14.25</span>：<code>following</code> 和 <code>followers</code> 动作 <span class="red">RED</span></h5>

<div class="source-file">app/controllers/users_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span>
                                        <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Following"</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Followers"</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>读过本书前面的内容我们发现，按照 Rails 的约定，动作最后都会隐式渲染对应的视图，例如 <code>show</code> 动作最后会渲染 <code>show.html.erb</code>。而<a class="xref-link" href="#listing-following-followers-actions">代码清单 14.25</a> 中的两个动作都显式调用了 <code>render</code> 方法，渲染一个名为 <code>show_follow</code> 的视图。下面我们来编写这个视图。这两个动作之所以使用同一个视图，是因为两种情况用到的 ERb 代码差不多，如<a class="xref-link" href="#listing-show-follow-view">代码清单 14.26</a> 所示。</p>
<div id="listing-show-follow-view" data-type="listing">
<h5><span class="title-label">代码清单 14.26</span>：渲染我关注的用户列表页面和关注我的用户列表页面的 <code>show_follow</code> 视图</h5>

<div class="source-file">app/views/users/show_follow.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user_avatars"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size: </span><span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users follow"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="#listing-following-followers-actions">代码清单 14.25</a> 中的动作会按需渲染<a class="xref-link" href="#listing-show-follow-view">代码清单 14.26</a> 中的视图，分别显式我关注的用户列表和关注我的用户列表，如<a class="xref-link" href="#fig-user-following">图 14.16</a> 和<a class="xref-link" href="#fig-user-followers">图 14.17</a> 所示。注意，上述代码都没用到“当前用户”，所以这两个链接对其他用户也可用，如<a class="xref-link" href="#fig-different-user-followers">图 14.18</a> 所示。</p>
<p>现在，<a class="xref-link" href="#listing-following-followers-authorization-test">代码清单 14.24</a> 中的测试应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.27</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<div id="fig-user-following" class="figure"><img src="images/chapter14/user_following_3rd_edition.png" alt="user following 3rd edition" /><div class="figcaption"><span class="title-label">图 14.16</span>：显示某个用户关注的人</div></div>
<div id="fig-user-followers" class="figure"><img src="images/chapter14/user_followers_3rd_edition.png" alt="user followers 3rd edition" /><div class="figcaption"><span class="title-label">图 14.17</span>：显示关注某个用户的人</div></div>
<div id="fig-different-user-followers" class="figure"><img src="images/chapter14/diferent_user_followers_3rd_edition.png" alt="diferent user followers 3rd edition" /><div class="figcaption"><span class="title-label">图 14.18</span>：显示关注另一个用户的人</div></div>
<p>现在，这两个页面可以使用了，下面要编写一些简短的集成测试，确认表现正确。这些测试只是健全检查，无需面面俱到。正如 <a class="xref-link" href="chapter5.html#layout-link-tests">5.3.4 节</a>所说的，全面的测试，例如检查 HTML 结构，并不牢靠，而且可能适得其反。对这两个页面来说，我们计划确认显示的数量正确，而且页面中有指向正确的 URL 的链接。</p>
<p>首先，和之前一样，生成一个集成测试文件：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails generate integration_test following
      invoke  test_unit
      create    <span class="nb">test</span>/integration/following_test.rb
</code></pre></div>
</div>
<p>然后，准备测试数据。我们要在“关系”固件中创建一些关注关系。<a class="xref-link" href="chapter13.html#profile-micropost-tests">13.2.3 节</a>使用下面的代码把微博和用户关联起来：</p>
<div data-type="listing">


<div class="highlight language-yaml"><pre><code><span class="na">orange</span><span class="pi">:</span>
  <span class="na">content</span><span class="pi">:</span> <span class="s2">"</span><span class="s">I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="na">created_at</span><span class="pi">:</span> <span class="s">&lt;%= 10.minutes.ago %&gt;</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">michael</span>
</code></pre></div>
</div>
<p>注意，我们没有用 <code>user_id: 1</code>，而是 <code>user: michael</code>。</p>
<p>按照这种方式编写“关系”固件，如<a class="xref-link" href="#listing-relationships-fixtures">代码清单 14.28</a> 所示。</p>
<div id="listing-relationships-fixtures" data-type="listing">
<h5><span class="title-label">代码清单 14.28</span>：“关系”固件</h5>

<div class="source-file">test/fixtures/relationships.yml</div>

<div class="highlight language-yaml"><pre><code><span class="na">one</span><span class="pi">:</span>
  <span class="na">follower</span><span class="pi">:</span> <span class="s">michael</span>
  <span class="na">followed</span><span class="pi">:</span> <span class="s">lana</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="na">follower</span><span class="pi">:</span> <span class="s">michael</span>
  <span class="na">followed</span><span class="pi">:</span> <span class="s">malory</span>

<span class="na">three</span><span class="pi">:</span>
  <span class="na">follower</span><span class="pi">:</span> <span class="s">lana</span>
  <span class="na">followed</span><span class="pi">:</span> <span class="s">michael</span>

<span class="na">four</span><span class="pi">:</span>
  <span class="na">follower</span><span class="pi">:</span> <span class="s">archer</span>
  <span class="na">followed</span><span class="pi">:</span> <span class="s">michael</span>
</code></pre></div>
</div>
<p>在这些固件中，Michael 关注了 Lana 和 Malory，Lana 和 Archer 关注了 Michael。为了测试数量，我们可以使用检查资料页面中微博数量的 <code>assert_match</code> 方法（<a class="xref-link" href="chapter13.html#listing-user-profile-test">代码清单 13.28</a>）。然后再检查页面中有没有正确的链接，如<a class="xref-link" href="#listing-following-tests">代码清单 14.29</a> 所示。</p>
<div id="listing-following-tests" data-type="listing">
<h5><span class="title-label">代码清单 14.29</span>：测试我关注的用户列表页面和关注我的用户列表页面 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/following_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"following page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">count</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"followers page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">count</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>注意，在这段测试中有下面这个断言：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">assert_not</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre></div>
</div>
<p>如果不加入这个断言，下面这段代码就没有实际意义：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="vi">@user</span><span class="p">.</span><span class="nf">following</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>（对关注我的用户列表页面的测试也是一样。）也就是说，如果 <code>@user.following.empty?</code> 的值是 <code>true</code>，循环中的 <code>assert_select</code> 都不会执行，这样测试会通过，给我们一种安全的错觉。</p>
<p>测试组件应该可以通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.30</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-following-and-followers-pages" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在浏览器中确认 /users/1/followers 和 /users/1/following 页面能显示正确的内容。侧边栏中的头像链接正确吗？</p>
</li>
<li>
<p>把<a class="xref-link" href="#listing-following-tests">代码清单 14.29</a> 中 <code>assert_select</code> 断言对应的应用代码注释掉，确认测试会失败，从而证明测试写的正确。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="a-working-follow-button-the-standard-way">
<h2><span class="title-label">14.2.4</span> 关注按钮的常规实现方式</h2>
<p>视图创建好了，下面我们要让关注和取消关注按钮起作用。因为关注和取消关注涉及到创建和销毁“关系”，所以我们需要一个控制器。像之前一样，我们使用下面的命令生成这个控制器：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails generate controller Relationships
</code></pre></div>
</div>
<p>在<a class="xref-link" href="#listing-relationships-controller">代码清单 14.32</a> 中会看到，限制访问这个控制器中的动作没有太大的意义，但我们还是要加入安全机制。我们要在测试中确认，访问这个控制器中的动作之前要先登录（没登录就重定向到登录页面），而且数据库中的“关系”数量没有变化，如<a class="xref-link" href="#listing-relationships-access-control">代码清单 14.31</a> 所示。</p>
<div id="listing-relationships-access-control" data-type="listing">
<h5><span class="title-label">代码清单 14.31</span>：测试 <code>Relationships</code> 控制器的基本访问限制 <span class="red">RED</span></h5>

<div class="source-file">test/controllers/relationships_controller_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">RelationshipsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"create should require logged-in user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Relationship.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"destroy should require logged-in user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Relationship.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationships</span><span class="p">(</span><span class="ss">:one</span><span class="p">))</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>在 <code>Relationships</code> 控制器中添加 <code>logged_in_user</code> 前置过滤器后，这个测试就能通过，如<a class="xref-link" href="#listing-relationships-controller">代码清单 14.32</a> 所示。</p>
<div id="listing-relationships-controller" data-type="listing">
<h5><span class="title-label">代码清单 14.32</span>：为 <code>Relationships</code> 控制器添加访问限制 <span class="green">GREEN</span></h5>

<div class="source-file">app/controllers/relationships_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>为了让关注和取消关注按钮起作用，我们需要找到表单中 <code>followed_id</code> 字段（参见<a class="xref-link" href="#listing-follow-form">代码清单 14.21</a> 和<a class="xref-link" href="#listing-unfollow-form">代码清单 14.22</a>）对应的用户，然后再调用<a class="xref-link" href="#listing-follow-unfollow-following">代码清单 14.10</a> 中定义的 <code>follow</code> 或 <code>unfollow</code> 方法。各个动作完整的实现如<a class="xref-link" href="#listing-relationships-controller-following">代码清单 14.33</a> 所示。</p>
<div id="listing-relationships-controller-following" data-type="listing">
<h5><span class="title-label">代码清单 14.33</span>：<code>Relationships</code> 控制器的代码</h5>

<div class="source-file">app/controllers/relationships_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:followed_id</span><span class="p">])</span></span>
<span class="hll">    <span class="n">current_user</span><span class="p">.</span><span class="nf">follow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></span>
<span class="hll">    <span class="n">redirect_to</span> <span class="n">user</span></span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">followed</span></span>
<span class="hll">    <span class="n">current_user</span><span class="p">.</span><span class="nf">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></span>
<span class="hll">    <span class="n">redirect_to</span> <span class="n">user</span></span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>从这段代码中可以看出为什么前面说“限制访问没有太大意义”：如果未登录的用户直接访问某个动作（例如使用 <code>curl</code> 等命令行工具），<code>current_user</code> 的值是 <code>nil</code>，执行到这两个动作的第二行代码时会抛出异常，即得到一个错误，但对应用和数据来说都没危害。不过完全依赖这样的表现也不好，所以我们添加了一层安全防护措施。</p>
<p>现在，关注和取消关注功能都能正常使用了，任何用户都可以关注或取消关注其他用户。你可以在浏览器中点击相应的按钮验证一下。（我们会在 <a class="xref-link" href="#following-tests">14.2.6 节</a>编写集成测试检查这些操作。）关注第二个用户前后显示的资料页面如<a class="xref-link" href="#fig-unfollowed-user">图 14.19</a> 和<a class="xref-link" href="#fig-followed-user">图 14.20</a> 所示。</p>
<div id="fig-unfollowed-user" class="figure"><img src="images/chapter14/unfollowed_user.png" alt="unfollowed user" /><div class="figcaption"><span class="title-label">图 14.19</span>：关注前的资料页面</div></div>
<div id="fig-followed-user" class="figure"><img src="images/chapter14/followed_user.png" alt="followed user" /><div class="figcaption"><span class="title-label">图 14.20</span>：关注后的资料页面</div></div>
<h5 id="exercises-a-working-follow-button-the-standard-way" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在浏览器中关注第 2 个用户，然后取消关注。操作有效吗？</p>
</li>
<li>
<p>查看服务器日志，前一题中的两个操作渲染的是哪个模板？</p>
</li>
</ol>
</section>
<section data-type="sect2" id="a-working-follow-button-with-ajax">
<h2><span class="title-label">14.2.5</span> 关注按钮的 Ajax 实现方式</h2>
<p>虽然关注用户的功能已经完全实现了，但在实现动态流之前，还有可以增强的地方。你可能已经注意到了，在 <a class="xref-link" href="#a-working-follow-button-the-standard-way">14.2.4 节</a>中，<code>Relationships</code> 控制器的 <code>create</code> 和 <code>destroy</code> 动作最后都返回了一开始访问的用户资料页面。也就是说，用户 A 先访问用户 B 的资料页面，点击关注按钮关注用户 B，然后页面立即又转回到用户 B 的资料页面。因此，对这样的流程我们有一个疑问：为什么要多一次页面转向呢？</p>
<p>Ajax <sup>[<a id="fn-ref-8" href="#fn-8">8</a>]</sup>可以解决这种问题。Ajax 向服务器发送异步请求，在不刷新页面的情况下更新页面的内容。因为经常要在表单中处理 Ajax 请求，所以 Rails 提供了简单的实现方式。其实，关注和取消关注表单局部视图不用做大的改动，只要把 <code>form_for</code> 改成 <code>form_for…​, remote: true</code>，Rails 就会自动使用 Ajax 处理表单。这两个局部视图更新后的版本如<a class="xref-link" href="#listing-follow-form-ajax">代码清单 14.34</a> 和<a class="xref-link" href="#listing-unfollow-form-ajax">代码清单 14.35</a> 所示。</p>
<div id="listing-follow-form-ajax" data-type="listing">
<h5><span class="title-label">代码清单 14.34</span>：使用 Ajax 处理关注用户的表单</h5>

<div class="source-file">app/views/users/_follow.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="hll"><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">build</span><span class="p">,</span> <span class="ss">remote: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span></span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<div id="listing-unfollow-form-ajax" data-type="listing">
<h5><span class="title-label">代码清单 14.35</span>：使用 Ajax 处理取消关注用户的表单</h5>

<div class="source-file">app/views/users/_unfollow.html.erb</div>

<div class="highlight language-erb"><pre><code><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">followed_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">),</span>
             <span class="ss">html: </span><span class="p">{</span> <span class="ss">method: :delete</span> <span class="p">},</span>
<span class="hll">             <span class="ss">remote: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span></span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div>
</div>
<p>上述 ERb 代码生成的 HTML 没什么好说的，如果你好奇的话，可以看一下（细节可能不同）：</p>
<div data-type="listing">


<div class="highlight language-html"><pre><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/relationships/117"</span> <span class="na">class=</span><span class="s">"edit_relationship"</span> <span class="na">data-remote=</span><span class="s">"true"</span>
      <span class="na">id=</span><span class="s">"edit_relationship_117"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>
</div>
<p>可以看出，<code>form</code> 标签中设定了 <code>data-remote="true"</code>，这个属性告诉 Rails，这个表单可以使用 JavaScript 处理。Rails 遵从<a href="http://railscasts.com/episodes/205-unobtrusive-javascript" class="external-link">非侵入式 JavaScript</a>原则（unobtrusive JavaScript），没有直接在视图中写入 JavaScript 代码（Rails 之前的版本直接写入 JavaScript 代码），而是使用了一个简单的 HTML 属性。</p>
<p>修改表单后，我们要让 <code>Relationships</code> 控制器响应 Ajax 请求。为此，我们要使用 <code>respond_to</code> 方法，根据请求的类型生成合适的响应：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="p">.</span><span class="nf">js</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>这种写法可能会让人困惑，其实只有一行代码会执行。（<code>respond_to</code> 块中的代码更像是 <code>if-else</code> 语句，而不是代码序列。）为了让 <code>Relationships</code> 控制器响应 Ajax 请求，我们要在 <code>create</code> 和 <code>destroy</code> 动作（<a class="xref-link" href="#listing-relationships-controller-following">代码清单 14.33</a>）中添加类似上面的 <code>respond_to</code> 块，如<a class="xref-link" href="#listing-relationships-controller-ajax">代码清单 14.36</a> 所示。注意，我们把本地变量 <code>user</code> 改成了实例变量 <code>@user</code>，因为在<a class="xref-link" href="#listing-relationships-controller-following">代码清单 14.33</a> 中无需使用实例变量，而使用 Ajax 处理的表单（<a class="xref-link" href="#listing-follow-form-ajax">代码清单 14.34</a> 和<a class="xref-link" href="#listing-unfollow-form-ajax">代码清单 14.35</a>）则需要使用。</p>
<div id="listing-relationships-controller-ajax" data-type="listing">
<h5><span class="title-label">代码清单 14.36</span>：让 <code>Relationships</code> 控制器响应 Ajax 请求</h5>

<div class="source-file">app/controllers/relationships_controller.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:followed_id</span><span class="p">])</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">follow</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span></span>
<span class="hll">      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span></span>
<span class="hll">      <span class="nb">format</span><span class="p">.</span><span class="nf">js</span></span>
<span class="hll">    <span class="k">end</span></span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">followed</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">unfollow</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span></span>
<span class="hll">      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span></span>
<span class="hll">      <span class="nb">format</span><span class="p">.</span><span class="nf">js</span></span>
<span class="hll">    <span class="k">end</span></span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><a class="xref-link" href="#listing-relationships-controller-ajax">代码清单 14.36</a> 中的代码会优雅降级（不过要配置一个选项，如<a class="xref-link" href="#listing-degrade-gracefully">代码清单 14.37</a> 所示），如果浏览器不支持 JavaScript，也能正常运行。</p>
<div id="listing-degrade-gracefully" data-type="listing">
<h5><span class="title-label">代码清单 14.37</span>：添加优雅降级所需的配置</h5>

<div class="source-file">config/application.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../boot'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
<span class="p">.</span>
<span class="nf">.</span>
<span class="p">.</span>
<span class="nf">module</span> <span class="no">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="o">.</span>
    <span class="c1"># 在使用 Ajax 处理的表单中添加真伪令牌</span>
<span class="hll">    <span class="n">config</span><span class="p">.</span><span class="nf">action_view</span><span class="p">.</span><span class="nf">embed_authenticity_token_in_remote_forms</span> <span class="o">=</span> <span class="kp">true</span></span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>当然，如果支持 JavaScript，也能正确响应。如果是 Ajax 请求，Rails 会自动调用包含 JavaScript 的嵌入式 Ruby 文件（<code>.js.erb</code>），文件名和动作一样，例如 <code>create.js.erb</code> 或 <code>destroy.js.erb</code>。你可能猜到了，在这种文件中既可以使用 JavaScript 也可以使用嵌入式 Ruby 处理当前页面。所以，为了更新关注后和取消关注后的页面，我们要创建这种文件。</p>
<p>在 JS-ERb 文件中，Rails 自动提供了 <a href="http://jquery.com/" class="external-link">jQuery</a> 库的辅助函数，可以通过<a href="http://www.w3.org/DOM/" class="external-link">文档对象模型</a>（Document Object Model，简称 DOM）处理页面中的内容。jQuery 库中有很多处理 DOM 的方法，但现在我们只会用到其中两个。首先，我们要知道通过 ID 获取 DOM 元素的美元符号，例如，要获取 <code>follow_form</code> 元素，可以使用如下的代码：</p>
<div data-type="listing">


<div class="highlight language-javascript"><pre><code><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>（参见<a class="xref-link" href="#listing-follow-form-partial">代码清单 14.19</a>，这个元素是包含表单的 <code>div</code> 元素，而不是表单本身。）上面的句法和 CSS 一样，<code>#</code> 符号表示 CSS ID。由此你可能猜到了，jQuery 和 CSS 一样，使用点号 <code>.</code> 表示 CSS 类。</p>
<p>我们要使用的第二个方法是 <code>html</code>，使用指定的内容修改元素中的 HTML。例如，如果要把整个表单换成字符串 <code>"foobar"</code>，可以这么写：</p>
<div data-type="listing">


<div class="highlight language-javascript"><pre><code><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>和常规的 JavaScript 文件不同，JS-ERb 文件还可以使用嵌入式 Ruby 代码。在 <code>create.js.erb</code> 文件中，（成功关注后）我们会把关注用户表单换成取消关注用户表单，并更新关注数量，如<a class="xref-link" href="#listing-create-js-erb">代码清单 14.38</a> 所示。这段代码中用到了 <code>escape_javascript</code> 方法，在 JavaScript 中写入 HTML 代码必须使用这个方法对 HTML 进行转义。</p>
<div id="listing-create-js-erb" data-type="listing">
<h5><span class="title-label">代码清单 14.38</span>：创建“关系”的 JS-ERb 代码</h5>

<div class="source-file">app/views/relationships/create.js.erb</div>

<div class="highlight language-erb"><pre><code>$("#follow_form").html("<span class="cp">&lt;%=</span> <span class="n">escape_javascript</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="s1">'users/unfollow'</span><span class="p">))</span> <span class="cp">%&gt;</span>");
$("#followers").html('<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>');
</code></pre></div>
</div>
<p>注意，上述代码的行尾有分号，这是 <a href="https://en.wikipedia.org/wiki/ALGOL" class="external-link">ALGOL</a> 语言系的一个特色。</p>
<p><code>destroy.js.erb</code> 文件的内容类似，如<a class="xref-link" href="#listing-destroy-js-erb">代码清单 14.39</a> 所示。</p>
<div id="listing-destroy-js-erb" data-type="listing">
<h5><span class="title-label">代码清单 14.39</span>：销毁“关系”的 JS-ERb 代码</h5>

<div class="source-file">app/views/relationships/destroy.js.erb</div>

<div class="highlight language-erb"><pre><code>$("#follow_form").html("<span class="cp">&lt;%=</span> <span class="n">escape_javascript</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="s1">'users/follow'</span><span class="p">))</span> <span class="cp">%&gt;</span>");
$("#followers").html('<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">followers</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>');
</code></pre></div>
</div>
<p>加入上述代码后，你应该访问用户资料页面，看一下关注或取消关注用户后页面是不是真的没有刷新。</p>
<h5 id="exercises-a-working-follow-button-with-ajax" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>在浏览器中取消关注第 2 个用户，然后重新关注。操作有效吗？</p>
</li>
<li>
<p>查看服务器日志，前一题中的两个操作渲染的是哪个模板？</p>
</li>
</ol>
</section>
<section data-type="sect2" id="following-tests">
<h2><span class="title-label">14.2.6</span> 关注功能的测试</h2>
<p>关注按钮可以使用了，现在我们要编写一些简单的测试，避免回归。关注用户时，我们要向相应的地址发送 <code>POST</code> 请求，确认关注的人数增加了一个：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">followed_id: </span><span class="vi">@other</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>这是测试普通请求的方式，测试 Ajax 请求的方式基本类似，唯一的区别是要指定 <code>xhr: true</code> 参数：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">followed_id: </span><span class="vi">@other</span><span class="p">.</span><span class="nf">id</span> <span class="p">},</span> <span class="ss">xhr: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p><code>xhr</code> 是 XmlHttpRequest 的简称，把 <code>xhr</code> 参数的值设为 <code>true</code> 之后，会发送 Ajax 请求，目的是执行 <code>respond_to</code> 块中对应于 JavaScript 的代码（<a class="xref-link" href="#listing-relationships-controller-ajax">代码清单 14.36</a>）。</p>
<p>取消关注的测试类似，只需把 <code>post</code> 换成 <code>delete</code>。在下面的代码中，我们检查关注的人数减少了一个，而且指定了“关系”和被关注用户的 ID。</p>
<p>普通请求：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>Ajax 请求：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">),</span> <span class="ss">xhr: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>综上所述，测试如<a class="xref-link" href="#listing-follow-button-tests">代码清单 14.40</a> 所示。</p>
<div id="listing-follow-button-tests" data-type="listing">
<h5><span class="title-label">代码清单 14.40</span>：测试关注和取消关注按钮 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/following_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@other</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span></span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"should follow a user the standard way"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">followed_id: </span><span class="vi">@other</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should follow a user with Ajax"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">xhr: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">followed_id: </span><span class="vi">@other</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should unfollow a user the standard way"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">follow</span><span class="p">(</span><span class="vi">@other</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">followed_id: </span><span class="vi">@other</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should unfollow a user with Ajax"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">follow</span><span class="p">(</span><span class="vi">@other</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">active_relationships</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">followed_id: </span><span class="vi">@other</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">),</span> <span class="ss">xhr: </span><span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>测试组件应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.41</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-following-tests" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>分别注释掉 <code>respond_to</code> 块中的各行代码（<a class="xref-link" href="#listing-relationships-controller-ajax">代码清单 14.36</a>），确认测试会失败，然后再把注释去掉，让测试通过，从而证明测试写的正确。在这个过程中分别是哪个测试失败的？</p>
</li>
<li>
<p>如果把<a class="xref-link" href="#listing-follow-button-tests">代码清单 14.40</a> 中的某个 <code>xhr: true</code> 删掉，会发生什么？说说为什么会这样，以及为什么前一题的操作过程能捕获这个问题。</p>
</li>
</ol>
</section>
</section>
<section data-type="sect1" id="the-status-feed">
<h1><span class="title-label">14.3</span> 动态流</h1>
<p>接下来我们要实现这个演示应用最难的功能：微博动态流。基本上本节的内容算是全书最高深的。完整的动态流以 <a class="xref-link" href="chapter13.html#a-proto-feed">13.3.3 节</a>的动态流原型为基础，动态流中除了当前用户自己的微博之外，还包含他关注的用户发布的微博。我们会采用循序渐进的方式实现动态流。在实现的过程中，会用到一些相当高级的 Rails、Ruby 和 SQL 技术。</p>
<p>因为我们要做的事情很多，在此之前最好先想清楚我们要实现的是什么功能。<a class="xref-link" href="#fig-page-flow-home-page-feed-mockup">图 14.5</a> 显示了最终要实现的动态流，<a class="xref-link" href="#fig-home-page-feed-mockup">图 14.21</a> 是同一幅图。</p>
<section data-type="sect2" id="motivation-and-strategy">
<h2><span class="title-label">14.3.1</span> 目的和策略</h2>
<p>我们对动态流的构思很简单。<a class="xref-link" href="#fig-user-feed">图 14.22</a> 中显示了 <code>microposts</code> 表示例和要显示的动态。动态流就是要把当前用户关注的用户发布的微博（也包括当前用户自己的微博）从 <code>microposts</code> 表中取出来，如图中的箭头所示。</p>
<div id="fig-home-page-feed-mockup" class="figure"><img src="images/chapter14/page_flow_home_page_feed_mockup_bootstrap.png" alt="page flow home page feed mockup bootstrap" /><div class="figcaption"><span class="title-label">图 14.21</span>：某个用户登录后看到的首页，显示有动态流</div></div>
<div id="fig-user-feed" class="figure"><img src="images/chapter14/user_feed.png" alt="user feed" /><div class="figcaption"><span class="title-label">图 14.22</span>：ID 为 1 的用户关注了 ID 为 2，7，8，10 的用户后得到的动态流</div></div>
<p>虽然我们还不知道怎么实现动态流，但测试的方法很明确，所以我们先写测试。测试的关键是要覆盖三种情况：动态流中既要包含关注的用户发布的微博，还要有用户自己的微博，但是不能包含未关注用户的微博。</p>
<p>按照<a class="xref-link" href="#listing-relationships-fixtures">代码清单 14.28</a>，我们将安排 Michael 关注 Lana，但不关注 Archer。根据<a class="xref-link" href="chapter10.html#listing-users-fixtures-extra-users">代码清单 10.47</a> 和<a class="xref-link" href="chapter13.html#listing-add-micropost-different-owner">代码清单 13.53</a> 中的固件，也就是说，Michael 要能看到 Lana 和自己的微博，但不能看到 Archer 的微博。把这个需求转换成测试，如<a class="xref-link" href="#listing-full-feed-test">代码清单 14.42</a> 所示。（用到了 <a class="xref-link" href="chapter13.html#listing-proto-status-feed">代码清单 13.46</a>定义的 <code>feed</code> 方法。）</p>
<div id="listing-full-feed-test" data-type="listing">
<h5><span class="title-label">代码清单 14.42</span>：测试动态流 <span class="red">RED</span></h5>

<div class="source-file">test/models/user_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"feed should have the right posts"</span> <span class="k">do</span>
    <span class="n">michael</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">lana</span>    <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:lana</span><span class="p">)</span>
    <span class="c1"># 关注的用户发布的微博</span>
    <span class="n">lana</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_following</span><span class="o">|</span>
      <span class="n">assert</span> <span class="n">michael</span><span class="p">.</span><span class="nf">feed</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">post_following</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># 自己的微博</span>
    <span class="n">michael</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_self</span><span class="o">|</span>
      <span class="n">assert</span> <span class="n">michael</span><span class="p">.</span><span class="nf">feed</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">post_self</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># 未关注用户的微博</span>
    <span class="n">archer</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_unfollowed</span><span class="o">|</span>
      <span class="n">assert_not</span> <span class="n">michael</span><span class="p">.</span><span class="nf">feed</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">post_unfollowed</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<p>当然，现在的动态流只是个原型，测试无法通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.43</span>：<strong class="red">RED</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<h5 id="exercises-motivation-and-strategy" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>假设微博的 ID 是连续的，而且数字大的是最近发布的。对<a class="xref-link" href="#fig-user-feed">图 14.22</a> 中的动态流而言，<code>user.feed.map(:id)</code> 的返回值是什么？提示：回顾一下 <a class="xref-link" href="chapter13.html#micropost-refinements">13.1.4 节</a>定义的默认作用域。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="a-first-feed-implementation">
<h2><span class="title-label">14.3.2</span> 初步实现动态流</h2>
<p>有了检查动态流的测试后（<a class="xref-link" href="#listing-full-feed-test">代码清单 14.42</a>），我们可以开始实现动态流了。因为要实现的功能有点复杂，因此我们会一点一点实现。首先，我们要知道该使用怎样的查询语句。我们要从 <code>microposts</code> 表中取出关注的用户发布的微博（也要取出用户自己的微博）。为此，我们可以使用类似下面的查询语句：</p>
<div data-type="listing">


<div class="highlight language-sql"><pre><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</code></pre></div>
</div>
<p>编写这个查询语句时，我们假设 SQL 支持使用 <code>IN</code> 关键字检测集合中是否包含指定的元素。（还好，SQL 支持。）</p>
<p><a class="xref-link" href="chapter13.html#a-proto-feed">13.3.3 节</a>实现动态流原型时，我们使用 Active Record 中的 <code>where</code> 方法完成上面这种查询（<a class="xref-link" href="chapter13.html#listing-proto-status-feed">代码清单 13.46</a>）。那时所需的查询很简单，只是通过当前用户的 ID 取出他发布的微博：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</code></pre></div>
</div>
<p>而现在，我们遇到的情况复杂得多，要使用类似下面的代码实现：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</code></pre></div>
</div>
<p>从上面的查询条件可以看出，我们需要生成一个数组，其元素是关注的用户的 ID。生成这个数组的方式之一是，使用 Ruby 中的 <code>map</code> 方法，这个方法可以在任意可枚举的对象（enumerable）上调用，<sup>[<a id="fn-ref-9" href="#fn-9">9</a>]</sup>例如由一组元素组成的集合（数组或散列）。我们在 <a class="xref-link" href="chapter4.html#blocks">4.3.2 节</a>举例介绍过这个方法，下面再举个例子，把整数数组中的元素都转换成字符串：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><code><span class="go">$ rails console</span>
<span class="go">&gt;&gt; [1, 2, 3, 4].map { |i| i.to_s }</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">,</span> <span class="s2">"4"</span><span class="p">]</span>
</code></pre></div>
</div>
<p>像上面这种在每个元素上调用同一个方法的情况很常见，所以 Ruby 为此定义了一种简写形式（<a class="xref-link" href="chapter4.html#blocks">4.3.2 节</a>简介过）——在 <code>&amp;</code> 符号后面跟上被调用方法的符号形式：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><code><span class="go">&gt;&gt; [1, 2, 3, 4].map(&amp;:to_s)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">,</span> <span class="s2">"4"</span><span class="p">]</span>
</code></pre></div>
</div>
<p>使用 <code>join</code> 方法（<a class="xref-link" href="chapter4.html#arrays-and-ranges">4.3.1 节</a>）可以把数组中的元素合并起来组成字符串，各元素之间用逗号加一个空格分开：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><code><span class="go">&gt;&gt; [1, 2, 3, 4].map(&amp;:to_s).join(', ')</span>
<span class="p">=&gt;</span> <span class="s2">"1, 2, 3, 4"</span>
</code></pre></div>
</div>
<p>参照上面介绍的方法，我们可以在 <code>user.following</code> 中的每个元素上调用 <code>id</code> 方法，得到一个由关注的用户 ID 组成的数组。例如，对数据库中的第一个用户而言，可以使用下面的方法得到这个数组：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><code><span class="go">&gt;&gt; User.first.following.map(&amp;:id)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
<span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span>
<span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">]</span>
</code></pre></div>
</div>
<p>其实，因为这种用法太普遍了，所以 Active Record 默认已经提供了：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><code><span class="go">&gt;&gt; User.first.following_ids</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
<span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span>
<span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">]</span>
</code></pre></div>
</div>
<p>上述代码中的 <code>following_ids</code> 方法是 Active Record 根据 <code>has_many :following</code> 关联（<a class="xref-link" href="#listing-has-many-following-through-active-relationships">代码清单 14.8</a>）合成的。因此，我们只需在关联名后面加上 <code>_ids</code> 就可以获取 <code>user.following</code> 集合中所有用户的 ID。用户 ID 组成的字符串如下：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><code><span class="go">&gt;&gt; User.first.following_ids.join(', ')</span>
<span class="p">=&gt;</span> <span class="s2">"3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="s2">23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="s2">42, 43, 44, 45, 46, 47, 48, 49, 50, 51"</span>
</code></pre></div>
</div>
<p>不过，插入 SQL 语句时，无须手动生成字符串，<code>?</code> 插值操作会为你代劳（同时也避免了一些数据库之间的兼容问题）。因此，实际上只需要使用 <code>following_ids</code> 而已。所以，之前猜测的写法确实可用：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</code></pre></div>
</div>
<p><code>feed</code> 方法的定义如<a class="xref-link" href="#listing-initial-working-feed">代码清单 14.44</a> 所示。</p>
<div id="listing-initial-working-feed" data-type="listing">
<h5><span class="title-label">代码清单 14.44</span>：初步实现的动态流 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
  <span class="c1"># 如果密码重设请求超时了，返回 true</span>
  <span class="k">def</span> <span class="nf">password_reset_expired?</span>
    <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">ago</span>
  <span class="k">end</span>

  <span class="c1"># 返回用户的动态流</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></span>
  <span class="k">end</span>

  <span class="c1"># 关注另一个用户</span>
  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">following</span> <span class="o">&lt;&lt;</span> <span class="n">other_user</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>现在测试组件应该可以通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.45</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<p>在某些应用中，这样的初步实现已经能满足大部分需求了，但这不是我们最终要使用的实现方式。在阅读下一节之前，你可以想一下为什么。（提示：如果用户关注了 5000 个人呢？）</p>
<h5 id="exercises-a-first-feed-implementation" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>把<a class="xref-link" href="#listing-initial-working-feed">代码清单 14.44</a> 中查询用户自己的微博的代码去掉，<a class="xref-link" href="#listing-full-feed-test">代码清单 14.42</a> 中的哪个测试会失败？</p>
</li>
<li>
<p>把<a class="xref-link" href="#listing-initial-working-feed">代码清单 14.44</a> 中查询关注用户的微博的代码去掉，<a class="xref-link" href="#listing-full-feed-test">代码清单 14.42</a> 中的哪个测试会失败？</p>
</li>
<li>
<p>如何修改<a class="xref-link" href="#listing-initial-working-feed">代码清单 14.44</a> 中的查询才能返回未关注用户的微博（此时<a class="xref-link" href="#listing-full-feed-test">代码清单 14.42</a> 中的第三个测试会失败）？提示：返回全部微博即可。</p>
</li>
</ol>
</section>
<section data-type="sect2" id="subselects">
<h2><span class="title-label">14.3.3</span> 子查询</h2>
<p>如前一节末尾所说，对 <a class="xref-link" href="#a-first-feed-implementation">14.3.2 节</a>的实现方式来说，如果用户关注了 5000 个人，动态流中的微博数量会变多，性能就会下降。本节，我们将重新实现动态流，在关注的用户数量很多时，性能也很好。</p>
<p><a class="xref-link" href="#a-first-feed-implementation">14.3.2 节</a>中存在问题的是 <code>following_ids</code> 这行代码，它会把关注的所有用户 ID 取出，加载到内存中，还会创建一个元素数量和关注的用户数量相同的数组。既然<a class="xref-link" href="#listing-initial-working-feed">代码清单 14.44</a> 的目的只是为了检查集合中是否包含指定的元素，那么就一定有一种更高效的方式。其实 SQL 真的提供了针对这种问题的优化措施：使用子查询（subselect），在数据库层查找关注的用户 ID。</p>
<p>针对动态流的重构，先从<a class="xref-link" href="#listing-feed-second-cut">代码清单 14.46</a> 中的小改动开始。</p>
<div id="listing-feed-second-cut" data-type="listing">
<h5><span class="title-label">代码清单 14.46</span>：在获取动态流的 <code>where</code> 方法中使用键值对 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
  <span class="c1"># 返回用户的动态流</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (:following_ids) OR user_id = :user_id"</span><span class="p">,</span></span>
<span class="hll">                    <span class="ss">following_ids: </span><span class="n">following_ids</span><span class="p">,</span> <span class="ss">user_id: </span><span class="nb">id</span><span class="p">)</span></span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>为了给下一步重构做准备，我们把</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</code></pre></div>
</div>
<p>换成了等效的</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (:following_ids) OR user_id = :user_id"</span><span class="p">,</span>
                <span class="ss">following_ids: </span><span class="n">following_ids</span><span class="p">,</span> <span class="ss">user_id: </span><span class="nb">id</span><span class="p">)</span>
</code></pre></div>
</div>
<p>使用问号做插值虽然可以，但如果要在多处插入同一个值，后一种写法更方便。</p>
<p>上面这段话表明，我们要在 SQL 查询语句中两次用到 <code>user_id</code>。具体而言，我们要把下面这行 Ruby 代码</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">following_ids</span>
</code></pre></div>
</div>
<p>换成包含 SQL 语句的代码</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><code><span class="n">following_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                 WHERE  follower_id = :user_id"</span>
</code></pre></div>
</div>
<p>上面这行代码使用了 SQL 子查询语句。针对 ID 为 1 的用户，整个查询语句是这样的：</p>
<div data-type="listing">


<div class="highlight language-sql"><pre><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span>  <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>使用子查询后，所有的集合包含关系都交由数据库处理，这样效率更高。</p>
<p>有了这些基础，我们就可以着手实现更高效的动态流了，如<a class="xref-link" href="#listing-feed-final">代码清单 14.47</a> 所示。注意，因为现在使用的是纯 SQL 语句，所以要使用插值方式把 <code>following_ids</code> 加入语句中，而不能使用转义的方式。</p>
<div id="listing-feed-final" data-type="listing">
<h5><span class="title-label">代码清单 14.47</span>：动态流的最终实现 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
  <span class="c1"># 返回用户的动态流</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="n">following_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE  follower_id = :user_id"</span>
    <span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id IN (</span><span class="si">#{</span><span class="n">following_ids</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                     OR user_id = :user_id"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
</div>
<p>这段代码结合了 Rails、Ruby 和 SQL 的优势，达到了目的，而且做得很好：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 14.48</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
</code></pre></div>
</div>
<p>当然，子查询也不是万能的。对于更大型的网站而言，可能要使用后台作业（background job）异步生成动态流。性能优化这个话题已经超出了本书范畴。</p>
<p>现在，动态流完全实现了。<a class="xref-link" href="chapter13.html#a-proto-feed">13.3.3 节</a>已经在首页加入了动态流，不过<a class="xref-link" href="chapter13.html#user-microposts">第 13 章</a>实现的只是动态流原型（<a class="xref-link" href="chapter13.html#fig-home-with-proto-feed">图 13.14</a>），添加<a class="xref-link" href="#listing-feed-final">代码清单 14.47</a> 中的代码后，首页显示的动态流完整了，如<a class="xref-link" href="#fig-home-page-with-feed">图 14.23</a> 所示。</p>
<p>现在可以把改动合并到 <code>master</code> 分支了：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>rails <span class="nb">test</span>
<span class="nv">$ </span>git add <span class="nt">-A</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add user following"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge following-users
</code></pre></div>
</div>
<p>然后再推送到远程仓库，并部署到生产环境：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><code><span class="nv">$ </span>git push
<span class="nv">$ </span>git push heroku
<span class="nv">$ </span>heroku pg:reset DATABASE
<span class="nv">$ </span>heroku run rails db:migrate
<span class="nv">$ </span>heroku run rails db:seed
</code></pre></div>
</div>
<p>在生产环境的线上网站中也会显示动态流，如<a class="xref-link" href="#fig-live-status-feed">图 14.24</a> 所示。</p>
<div id="fig-home-page-with-feed" class="figure"><img src="images/chapter14/home_page_with_feed_3rd_edition.png" alt="home page with feed 3rd edition" /><div class="figcaption"><span class="title-label">图 14.23</span>：首页，显示有动态流</div></div>
<div id="fig-live-status-feed" class="figure"><img src="images/chapter14/live_status_feed.png" alt="live status feed" /><div class="figcaption"><span class="title-label">图 14.24</span>：线上网站中显示的动态流</div></div>
<h5 id="exercises-subselects" class="discrete">练习</h5>
<ol class="arabic">
<li>
<p>编写集成测试，检查首页正确显示了动态流的第一页。模板参见<a class="xref-link" href="#listing-home-feed-test">代码清单 14.49</a>。</p>
</li>
<li>
<p>注意，<a class="xref-link" href="#listing-home-feed-test">代码清单 14.49</a> 使用 <code>CGI.escapeHTML</code> 方法转义了 HTML，想一下为什么要这么做。提示：把转义的代码去掉，仔细查看不匹配的微博内容源码。在终端中使用搜索功能（大多数系统可按 Cmd-F 或 Ctrl-F 键），查找“sorry”这个词。</p>
</li>
</ol>
<div id="listing-home-feed-test" data-type="listing">
<h5><span class="title-label">代码清单 14.49</span>：测试动态流的 HTML <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/following_test.rb</div>

<div class="highlight language-ruby"><pre><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">test</span> <span class="s2">"feed on Home page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">feed</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
      <span class="n">assert_match</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escapeHTML</span><span class="p">(</span><span class="no">FILL_IN</span><span class="p">),</span> <span class="no">FILL_IN</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
</section>
</section>
<section data-type="sect1" id="following-users-conclusion">
<h1><span class="title-label">14.4</span> 小结</h1>
<p>实现动态流之后，本书的演示应用就开发完了。这个应用演示了 Rails 的全部重要功能，包括模型、视图、控制器、模板、局部视图、过滤器、数据验证、回调、<code>has_many</code>/<code>belongs_to</code> 关联、<code>has_many :through</code> 关联、安全、测试和部署。</p>
<p>除此之外，Rails 还有很多功能值得我们学习。下面提供了一些后续学习资源，可在以后的学习中优先使用。</p>
<section data-type="sect2" id="guide-to-further-resources">
<h2><span class="title-label">14.4.1</span> 后续的学习资源</h2>
<p>商店和网上都有很多 Rails 资源，而且多得让你挑花眼。可喜的是，读完这本书后，你已经可以学习几乎所有其他的知识了。下面是建议你后续学习的资源：</p>
<ul>
<li>
<p><a href="http://learnenough.com/story" class="external-link">The Learn Enough Society</a>：收费订阅服务，提供本书的特别增强版和 15 个小时多的视频课程。我在这些视频中介绍了很多技巧，而且还提供了在线示例，光看本书是得不到这些的。此外，这项服务还包含 <a href="http://learnenough.com/" class="external-link">Learn Enough 系列教程</a>的文字资料和视频。如果你是学生，可以使用教育优惠。</p>
</li>
<li>
<p><a href="http://launchschool.com/railstutorial" class="external-link">Launch School</a>：近些年涌现了很多开发者现场训练营，我建议在当地参与一个。不过，Launch School 是在线训练营，在任何地方都能参加。如果你希望有人按照结构化课程教你，Launch School 是不错的选择。</p>
</li>
<li>
<p><a href="http://bloc.io/" class="external-link">Bloc</a>：一个在线训练营，有结构化的课程、个人导师，通过具体的项目学习知识。使用 BLOCLOVESHARTL 优惠码报名费可以省 $500。</p>
</li>
<li>
<p><a href="http://www.thefirehoseproject.com/?tid=HARTL-RAILS-TUT-EB2&amp;pid=HARTL-RAILS-TUT-EB2" class="external-link">Firehose Project</a>：导师制在线编程训练营，专注于具体的编程技能，如测试驱动开发、算法，以及敏捷 Web 应用开发。有两周免费的入门课程。</p>
</li>
<li>
<p><a href="http://www.thinkful.com/a/railstutorial" class="external-link">Thinkful</a>：在线课程，由专业的工程师辅导开发项目。教授的课程包括 Ruby on Rails、前端开发、Web 设计和数据库科学。</p>
</li>
<li>
<p><a href="https://pragmaticstudio.com/refs/railstutorial" class="external-link">Pragmatic Studio</a>：Mike 和 Nicole Clark 主讲的 Ruby 和 Rails 在线课程。</p>
</li>
<li>
<p><a href="https://tutorials.railsapps.org/hartl" class="external-link">RailsApps</a>：很多针对特定话题的 Rails 项目和教程，说明详细；</p>
</li>
<li>
<p><a href="http://mbsy.co/6VQ8l" class="external-link">Code School</a>：很多交互式编程课程。</p>
</li>
</ul>
</section>
<section data-type="sect2" id="following-users-learned">
<h2><span class="title-label">14.4.2</span> 本章所学</h2>
<ul>
<li>
<p>使用 <code>has_many :through</code> 可以实现数据模型之间的复杂关系；</p>
</li>
<li>
<p><code>has_many</code> 方法有很多可选的参数，可用来指定对象的类名和外键名；</p>
</li>
<li>
<p>使用 <code>has_many</code> 和 <code>has_many :through</code>，并且指定合适的类名和外键名，可以实现主动关系和被动关系；</p>
</li>
<li>
<p>Rails 支持嵌套路由；</p>
</li>
<li>
<p><code>where</code> 方法可以创建灵活且强大的数据库查询；</p>
</li>
<li>
<p>Rails 支持使用低层 SQL 语句查询数据库；</p>
</li>
<li>
<p>把本书实现的所有功能放在一起，最终实现了一个能关注用户并且显示动态流的应用。</p>
</li>
</ul>
</section>
</section>
</section>
          </article>

          <nav class="pagination">
            <ul class="pager">
              
              <li class="pager-prev"><a class="prev" href="chapter13.html" title="第 13 章 用户的微博">&laquo; 第 13 章 用户的微博</a></li>
              

              
            </ul>
          </nav>

          <div class="footnotes">
<ol>
<li id="fn-1">儿童图像的来源：http://www.flickr.com/photos/john_lustig/2518452221/，发布于 2013 年 12 月 16 日。Copyright © 2008 by John Lustig。未经改动，基于“知识共享 署名 2.0 通用”许可证使用。老虎图像来源：https://www.flickr.com/photos/renemensen/9187111340，发布于 2014 年 8 月 15 日。Copyright © 2013 by Rene Mesen。未经改动，基于“知识共享 署名 2.0 通用”许可证使用。 <a href="#fn-ref-1" class="symbol">&#8617;</a></li>
<li id="fn-2">简单起见，<a class="xref-link" href="#fig-naive-user-has-many-following">图 14.6</a> 省略了 <code>following</code> 表的 <code>id</code> 列。 <a href="#fn-ref-2" class="symbol">&#8617;</a></li>
<li id="fn-3">感谢读者 Paul Fioravanti 建议我使用这两个术语。 <a href="#fn-ref-3" class="symbol">&#8617;</a></li>
<li id="fn-4">严格来说，Rails 使用 <code>classify</code> 方法把 <code>has_many</code> 的参数转换成类名，例如 <code>"foo_bars"</code> 会转换成 <code>"FooBar"</code>。 <a href="#fn-ref-4" class="symbol">&#8617;</a></li>
<li id="fn-5">严格来说，Rails 使用 <code>underscore</code> 方法把类名转换为 id 列的名字。例如，<code>"FooBar".underscore</code> 的返回值是 <code>"foo_bar"</code>，所以 <code>FooBar</code> 模型的外键是 <code>foo_bar_id</code>。 <a href="#fn-ref-5" class="symbol">&#8617;</a></li>
<li id="fn-6">当你拥有某个领域大量建模的经验后，总能提前猜到这样的辅助方法。如果没有猜到的话，也经常能发现自己动手写这样的方法可以使测试代码更加整洁。此时，如果你没有猜到的话也很正常。软件开发往往是一个循序渐进的过程，你先埋头编写代码，发现代码很乱时，再重构。为了行文简洁，本书采取的是直捣黄龙的方法。 <a href="#fn-ref-6" class="symbol">&#8617;</a></li>
<li id="fn-7">路由设定中可以使用的参数详情，参阅 Rails 指南中《<a href="https://rails.guide/book/routing.html" class="external-link">Rails 路由全解</a>》一文。 <a href="#fn-ref-7" class="symbol">&#8617;</a></li>
<li id="fn-8">因为 Ajax 是 Asynchronous JavaScript and XML 的缩写，所以经常被错误的拼写为“AJAX”，不过在<a href="http://www.adaptivepath.org/ideas/ajax-new-approach-web-applications/" class="external-link">最初介绍 Ajax 的文章</a>中，通篇都拼写为“Ajax”。 <a href="#fn-ref-8" class="symbol">&#8617;</a></li>
<li id="fn-9">可枚举的对象主要的要求是实现了遍历集合的 <code>each</code> 方法。 <a href="#fn-ref-9" class="symbol">&#8617;</a></li>
</ol>
</div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p>&copy;2013-2017 <a href="http://about.ac" title="安道的个人网站" target="_blank">安道</a></p>
      <p>
        <a href="https://twitter.com/andor_chen" title="在 Twitter 中关注 @andor_chen"  target="_blank"><i class="icon-twitter"></i></a>
        <a href="http://weibo.com/andor27" title="在微博中关注 @andor_chen"  target="_blank"><i class="icon-weibo"></i></a>
      </p>
      <p>保留部分权利</p>
    </div>
  </footer>

</body>
</html>
